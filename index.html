<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CultureLink - Your Cultural Companion</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   
   <style>
/* ===== VARIABLES ET RESET ===== */
        :root {
            --primary-blue: #3A86FF;
            --primary-cyan: #00C9A7;
            --primary-light-blue: #5BC0DE;
            --primary-light-cyan: #7FD6C6;
            --nature-green: #2ECC71;
            --anime-orange: #FF9F1C;
            --culture-blue: #3A86FF;
            --bg-light: #F8FAFF;
            --bg-light-alt: #FFFFFF;
            --bg-dark: #0A0F1C;
            --card-light: #FFFFFF;
            --card-dark: #131B2E;
            --text-light: #1A1D29;
            --text-dark: #E6F7FF;
            --border-light: #E2E8F0;
            --border-dark: #2D3748;
            --header-bg-light: rgba(255, 255, 255, 0.95);
            --header-bg-dark: rgba(10, 15, 28, 0.95);
            --modal-bg-light: rgba(255, 255, 255, 0.98);
            --modal-bg-dark: rgba(19, 27, 46, 0.98);
            --panel-bg-light: rgba(255, 255, 255, 0.95);
            --panel-bg-dark: rgba(19, 27, 46, 0.95);
            --bot-message-bg: #f7f7f8;
            --user-message-bg: rgba(255, 255, 255, 0.15);
            --primary-color: var(--primary-blue);
            --secondary-color: var(--primary-cyan);
            --input-bg-light: rgba(255, 255, 255, 0.8);
            --input-bg-dark: rgba(255, 255, 255, 0.1);
        }

        [data-theme="light"] {
            --bg: var(--bg-light);
            --card: var(--card-light);
            --text: var(--text-light);
            --border: var(--border-light);
            --header-bg: var(--header-bg-light);
            --modal-bg: var(--modal-bg-light);
            --panel-bg: var(--panel-bg-light);
            --bot-message-bg: #f7f7f8;
            --user-message-bg: rgba(255, 255, 255, 0.8);
            --primary-color: var(--primary-blue);
            --secondary-color: var(--primary-cyan);
            --input-bg: var(--input-bg-light);
            --chat-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        [data-theme="dark"] {
            --bg: var(--bg-dark);
            --card: var(--card-dark);
            --text: var(--text-dark);
            --border: var(--border-dark);
            --header-bg: var(--header-bg-dark);
            --modal-bg: var(--modal-bg-dark);
            --panel-bg: var(--panel-bg-dark);
            --bot-message-bg: #1E293B;
            --user-message-bg: rgba(255, 255, 255, 0.1);
            --primary-color: var(--primary-blue);
            --secondary-color: var(--primary-cyan);
            --input-bg: var(--input-bg-dark);
            --chat-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        body.no-scroll {
            overflow: hidden;
        }

        /* Autoriser la sélection uniquement pour les messages */
        .message-text {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* ===== INTERFACES ===== */
        .interface {
            display: none;
            min-height: 100vh;
            flex-direction: column;
        }

        .interface.active {
            display: flex;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            height: 70px;
            animation: slideDown 0.5s ease;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 1.5rem;
            color: var(--secondary-color);
        }

        .logo-svg {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-cyan);
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-top-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            background: transparent;
            backdrop-filter: blur(10px);
            border: 1px solid transparent;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-cyan));
            color: white;
            box-shadow: 0 4px 15px rgba(58, 134, 255, 0.3);
        }

        .btn-secondary {
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            justify-content: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        /* ===== HERO SECTION ===== */
        .hero {
            text-align: center;
            padding: 1.5rem 2rem 1rem;
            max-width: 800px;
            margin: 0 auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            margin-top: 70px;
            animation: fadeIn 1s ease;
        }

        .profile-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .profile {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            box-shadow: 0 8px 25px rgba(58, 134, 255, 0.3);
            border: 4px solid var(--card);
            font-weight: bold;
            animation: pulse 2s infinite;
            position: relative;
            overflow: hidden;
            background: white;
        }

        .profile::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
        }

        .profile:hover::before {
            animation: shine 1.5s;
        }

        .profile-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .hero-title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            letter-spacing: -1px;
            animation: fadeInUp 0.8s ease 0.2s both;
        }

        .welcome-text {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-weight: 700;
            letter-spacing: -0.5px;
            animation: fadeInUp 0.8s ease 0.4s both;
        }

        .slogan {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 500;
            font-style: italic;
            animation: fadeInUp 0.8s ease 0.6s both;
        }

        .hero-description {
            font-size: 1rem;
            margin-bottom: 1.5rem;
            color: var(--text);
            opacity: 0.8;
            line-height: 1.6;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            animation: fadeInUp 0.8s ease 0.8s both;
        }

        .chat-instruction {
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
            color: var(--text);
            font-weight: 500;
            opacity: 0.7;
            animation: fadeInUp 0.8s ease 1s both;
        }

        .paw-btn-container {
            display: flex;
            justify-content: center;
            margin: 1rem 0;
            animation: fadeInUp 0.8s ease 1.2s both;
        }

        .paw-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-cyan));
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(58, 134, 255, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .paw-btn:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 12px 35px rgba(58, 134, 255, 0.5);
        }

        .paw-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        .paw-btn:hover::before {
            left: 100%;
        }

        .paw-icon {
            font-size: 2.5rem;
        }

        .hero-bottom-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            animation: fadeInUp 0.8s ease 1.4s both;
        }

        /* ===== CONTENT SECTIONS ===== */
        .content-sections {
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            display: grid;
            gap: 2rem;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .section {
            background: var(--card);
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.8s ease;
        }

        .section:nth-child(1) {
            animation-delay: 0.1s;
        }
        .section:nth-child(2) {
            animation-delay: 0.2s;
        }
        .section:nth-child(3) {
            animation-delay: 0.3s;
        }
        .section:nth-child(4) {
            animation-delay: 0.4s;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid;
        }

        .culture-header {
            border-color: var(--culture-blue);
        }

        .nature-header {
            border-color: var(--nature-green);
        }

        .anime-header {
            border-color: var(--anime-orange);
        }

        .learning-header {
            border-color: var(--primary-cyan);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .culture-title {
            color: var(--culture-blue);
        }

        .nature-title {
            color: var(--nature-green);
        }

        .anime-title {
            color: var(--anime-orange);
        }

        .learning-title {
            color: var(--primary-cyan);
        }

        .section-title i {
            font-size: 1.2rem;
            width: 30px;
            text-align: center;
        }

        .section-content {
            line-height: 1.7;
            color: var(--text);
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .culture-quote {
            background: rgba(58, 134, 255, 0.1);
            padding: 1.25rem;
            margin: 1.25rem 0;
            border-radius: 12px;
            border-left: 4px solid var(--primary-cyan);
            font-style: italic;
            font-size: 0.95rem;
        }

        .nature-quote {
            background: rgba(46, 204, 113, 0.1);
            border-left: 4px solid var(--nature-green);
        }

        .anime-quote {
            background: rgba(255, 159, 28, 0.1);
            border-left: 4px solid var(--anime-orange);
        }

        .learning-quote {
            background: rgba(0, 201, 167, 0.1);
            border-left: 4px solid var(--primary-cyan);
        }

        /* Décorations pour les sections */
        .nature-decoration {
            position: absolute;
            bottom: 10px;
            right: 10px;
            opacity: 0.3;
            font-size: 2rem;
            color: var(--nature-green);
            transition: all 0.3s ease;
        }

        .culture-decoration {
            position: absolute;
            bottom: 10px;
            right: 10px;
            opacity: 0.3;
            font-size: 2rem;
            color: var(--culture-blue);
            transition: all 0.3s ease;
        }

        .anime-decoration {
            position: absolute;
            bottom: 10px;
            right: 10px;
            opacity: 0.3;
            font-size: 2rem;
            color: var(--anime-orange);
            transition: all 0.3s ease;
        }

        .learning-decoration {
            position: absolute;
            bottom: 10px;
            right: 10px;
            opacity: 0.3;
            font-size: 2rem;
            color: var(--primary-cyan);
            transition: all 0.3s ease;
        }

        .section:hover .nature-decoration,
        .section:hover .culture-decoration,
        .section:hover .anime-decoration,
        .section:hover .learning-decoration {
            transform: scale(1.2);
            opacity: 0.5;
        }

        /* ===== DOWNLOAD SECTION ===== */
        .download-section {
            text-align: center;
            padding: 2rem 2rem 1rem;
            background: var(--card);
            margin-top: 1rem;
            border-top: 1px solid var(--border);
            position: relative;
        }

        .download-btn {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-cyan));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0 auto;
            box-shadow: 0 8px 25px rgba(58, 134, 255, 0.3);
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(58, 134, 255, 0.4);
        }

        .developer-note {
            font-size: 0.8rem;
            color: var(--text);
            opacity: 0.6;
            margin-top: 1rem;
            font-style: italic;
        }

        /* ===== FOOTER ===== */
        .footer {
            text-align: center;
            padding: 1.5rem 2rem;
            background: var(--card);
            border-top: 1px solid var(--border);
            position: sticky;
            bottom: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
        }

        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .copyright {
            font-size: 0.9rem;
            color: var(--text);
            white-space: nowrap;
            font-weight: 600;
            text-align: center;
            width: 100%;
        }

        /* ===== CHAT INTERFACE ===== */
        .chat-interface {
            background: var(--chat-bg);
            min-height: 100vh;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
            height: 70px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .chat-left-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .chat-center-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            text-align: center;
        }

        .chat-title {
            font-weight: 700;
            font-size: 1.1rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .conversation-name {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 2px;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-right-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .conversations-btn {
            position: relative;
        }

        .conversations-icon {
            display: flex;
            flex-direction: column;
            gap: 3px;
            width: 24px;
            height: 24px;
        }

        .conversations-line {
            height: 2px;
            background: var(--text);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .conversations-line:nth-child(1) {
            width: 100%;
        }

        .conversations-line:nth-child(2) {
            width: 80%;
        }

        /* ===== MESSAGES CONTAINER ===== */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            max-width: 768px;
            margin: 0 auto;
            width: 100%;
            position: relative;
            margin-top: 70px;
            margin-bottom: 80px;
            transition: all 0.3s ease;
            scroll-behavior: smooth;
            background: var(--chat-bg);
            position: relative;
        }

        /* Effet de profondeur pour le chat */
        .messages-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(to bottom, var(--bg) 0%, transparent 100%);
            pointer-events: none;
            z-index: 1;
        }

        /* Nouvelle conversation */
        .new-conversation {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 2rem;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            animation: fadeIn 0.5s ease;
            z-index: 2;
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
            animation: fadeInUp 0.8s ease 0.2s both;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            font-style: italic;
            margin-bottom: 2rem;
            opacity: 0.8;
            animation: fadeInUp 0.8s ease 0.4s both;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
            max-width: 500px;
            width: 100%;
        }

        .quick-action-btn {
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            white-space: nowrap;
            backdrop-filter: blur(10px);
        }

        .quick-action-btn.hidden-action {
            display: none;
        }

        .quick-action-btn:hover {
            background: var(--bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .quick-action-btn.more-btn {
            background: transparent;
            border: 1px dashed var(--border);
        }

        .privacy-notice {
            font-size: 0.85rem;
            color: var(--text);
            opacity: 0.6;
            margin-top: 2rem;
            max-width: 500px;
            line-height: 1.5;
            animation: fadeInUp 0.8s ease 0.8s both;
        }

        .hello-btn {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-cyan));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(58, 134, 255, 0.3);
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease 0.6s both;
        }

        .hello-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(58, 134, 255, 0.4);
        }

        /* ===== STYLE MESSAGES AMÉLIORÉ ===== */
        .message {
            display: flex;
            margin-bottom: 2rem;
            animation: messageSlideIn 0.3s ease;
            position: relative;
        }

        .user-message {
            justify-content: flex-end;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 90%;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            width: 100%;
        }

        .user-message .message-content {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
            position: relative;
            transition: transform 0.3s ease;
            overflow: hidden;
            background: var(--card);
            border: 2px solid var(--border);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .message-avatar.thinking {
            animation: rotateAvatar 2s linear infinite;
        }

        .user-message .message-avatar {
            background: linear-gradient(135deg, var(--primary-light-blue), var(--primary-light-cyan));
        }

        .bot-message .message-avatar.thinking::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top: 2px solid var(--primary-blue);
            animation: spin 1s linear infinite;
        }

        /* Style amélioré pour les messages - CORRIGÉ */
        .message-text {
            padding: 1rem 1.25rem;
            line-height: 1.7;
            position: relative;
            max-width: 100%;
            word-wrap: break-word;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            text-align: left;
        }

        .bot-message .message-text {
            background: transparent;
            color: var(--text);
            width: 100%;
            border-radius: 0;
            box-shadow: none;
            padding: 0.5rem 0;
            max-width: 100%;
        }

        .user-message .message-text {
            background: var(--user-message-bg);
            backdrop-filter: blur(10px);
            color: var(--text);
            width: 100%;
            border-radius: 18px 18px 4px 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
            max-width: 100%;
            word-break: break-word;
        }

        /* Style pour les images générées */
        .image-message {
            max-width: 100%;
        }

        .generated-image {
            margin: 1rem 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            position: relative;
        }

        .generated-image img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
        }

        .generated-image:hover img {
            transform: scale(1.02);
        }

        .image-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .image-action-btn {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .image-action-btn:hover {
            background: var(--bg);
            transform: translateY(-1px);
        }

        .image-action-btn.delete-btn {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .image-action-btn.delete-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .continue-btn {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .continue-btn:hover {
            background: var(--primary-cyan);
            transform: translateY(-2px);
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            color: var(--text);
            opacity: 0.8;
        }

        .typing-indicator .message-content {
            display: flex;
        }

        .typing-indicator .message-avatar {
            position: relative;
            animation: rotateAvatar 2s linear infinite;
        }

        .typing-indicator .message-avatar::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top: 2px solid var(--primary-blue);
            animation: spin 1s linear infinite;
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--text);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        /* ===== INPUT CONTAINER AMÉLIORÉ ===== */
        .input-container {
            padding: 1rem 1.5rem;
            background: var(--header-bg);
            border-top: 1px solid var(--border);
            backdrop-filter: blur(10px);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            max-width: 768px;
            margin: 0 auto;
            background: var(--input-bg);
            border-radius: 25px;
            border: 1px solid var(--border);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
            padding: 8px 15px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .message-input {
            flex: 1;
            padding: 12px 0;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 1rem;
            resize: none;
            min-height: 24px;
            max-height: 120px;
            font-family: inherit;
            outline: none;
            line-height: 1.5;
            overflow-y: auto;
        }

        .message-input::placeholder {
            color: var(--text);
            opacity: 0.7;
        }

        .send-button {
            background: var(--primary-blue);
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px;
            margin: 4px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover {
            background: var(--primary-cyan);
        }

        .send-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .send-button.stop {
            background: #ef4444;
        }

        .send-button.stop:hover {
            background: #dc2626;
        }

        .send-button.continue {
            background: #10B981;
        }

        .send-button.continue:hover {
            background: #059669;
        }

        /* ===== CONVERSATIONS PANEL ===== */
        .conversations-panel {
            position: fixed;
            top: 0;
            left: -100%;
            width: 80%;
            max-width: 280px;
            height: 100%;
            background: var(--panel-bg);
            border-right: 1px solid var(--border);
            z-index: 1000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .conversations-panel.active {
            left: 0;
        }

        .panel-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--header-bg);
        }

        .panel-title {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .panel-close {
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .panel-section {
            margin-bottom: 1.5rem;
        }

        .panel-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .panel-theme-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
            background: none;
            border: none;
            color: var(--text);
            font-size: 0.9rem;
        }

        .panel-theme-btn:hover {
            background: rgba(58, 134, 255, 0.1);
        }

        .panel-new-chat-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-cyan));
            border: none;
            color: white;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .panel-new-chat-btn:hover {
            opacity: 0.9;
        }

        .conversation-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .conversation-item:hover {
            background: rgba(58, 134, 255, 0.1);
            transform: translateX(5px);
        }

        .conversation-item.active {
            background: rgba(58, 134, 255, 0.2);
            border-color: var(--primary-blue);
        }

        .conversation-item.pinned {
            border-left: 4px solid var(--primary-cyan);
        }

        .conversation-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-cyan));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 0.8rem;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-title {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-preview {
            font-size: 0.8rem;
            opacity: 0.7;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conversation-date {
            font-size: 0.7rem;
            opacity: 0.5;
            margin-top: 0.25rem;
        }

        .conversation-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            gap: 2px;
        }

        .conversation-item:hover .conversation-actions {
            opacity: 1;
        }

        .conversation-action-btn {
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 0.8rem;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .conversation-action-btn:hover {
            opacity: 1;
            background: rgba(0,0,0,0.1);
        }

        .conversation-action-btn.pin-btn.pinned {
            color: var(--primary-cyan);
        }

        .panel-footer {
            padding: 1rem;
            border-top: 1px solid var(--border);
        }

        .panel-settings-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
            background: none;
            border: none;
            color: var(--text);
            font-size: 0.9rem;
        }

        .panel-settings-btn:hover {
            background: rgba(58, 134, 255, 0.1);
        }

        /* ===== SETTINGS PANEL ===== */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 80%;
            max-width: 280px;
            height: 100%;
            background: var(--panel-bg);
            border-left: 1px solid var(--border);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .settings-panel.active {
            right: 0;
        }

        /* ===== MODALS AMÉLIORÉS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--modal-bg);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .modal-content {
            line-height: 1.6;
        }

        .modal-content p {
            margin-bottom: 1rem;
        }

        .modal-text {
            max-height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            line-height: 1.6;
            border: 1px solid var(--border);
        }

        .modal-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .modal-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .modal-btn.primary {
            background: var(--primary-blue);
            color: white;
        }

        .modal-btn.secondary {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .modal-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .whatsapp-link {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: #25D366;
            color: white;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: background 0.2s;
        }

        .whatsapp-link:hover {
            background: #128C7E;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* Styles pour les listes dans les modals */
        .modal-content ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .modal-content li {
            margin-bottom: 0.5rem;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(200%) translateY(200%) rotate(45deg); }
        }

        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes avatarPulse {
            0% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(58, 134, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0); }
        }

        @keyframes typing {
            0%, 60%, 100% { transform: scale(1); opacity: 0.5; }
            30% { transform: scale(1.2); opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Nouvelle animation pour l'avatar qui tourne */
        @keyframes rotateAvatar {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== NOUVEAUX STYLES ===== */
        .language-selector {
            position: relative;
        }

        .language-btn {
            font-size: 1.2rem;
            position: relative;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            min-width: 140px;
            overflow: hidden;
            margin-top: 5px;
        }

        .language-dropdown.active {
            display: block;
        }

        .language-option {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid var(--border);
            background: var(--card);
        }

        .language-option:last-child {
            border-bottom: none;
        }

        .language-option:hover {
            background: var(--input-bg);
        }

        .language-option.active {
            background: rgba(58, 134, 255, 0.1);
            font-weight: 600;
        }

        .flag-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .scroll-to-bottom {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-blue);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 99;
            opacity: 0;
            transition: all 0.3s;
            transform: translateY(10px);
        }

        .scroll-to-bottom.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .scroll-to-bottom:hover {
            background: var(--primary-cyan);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 0.25rem;
            text-align: right;
        }

        .user-message .message-time {
            text-align: left;
        }

        .conversation-header {
            position: sticky;
            top: 0;
            background: var(--header-bg);
            z-index: 10;
            padding: 1rem 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        /* Style pour les messages avec images */
        .image-message .message-text {
            padding: 0;
        }
        
        .image-message .message-content {
            align-items: flex-start;
        }
        
        .message-image {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 0.5rem;
        }
        
        /* Style pour les messages texte */
        .text-message .message-text {
            padding: 1rem 1.25rem;
        }

        /* Éditeur de nom de conversation */
        .conversation-title-editor {
            display: none;
            width: 100%;
        }

        .conversation-title-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.9rem;
        }

        .conversation-title-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .conversation-title-display {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .conversation-title-display:hover {
            background: rgba(0,0,0,0.05);
        }

        /* Style pour les conversations épinglées */
        .pinned-conversations {
            margin-bottom: 1rem;
        }

        .pinned-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pinned-section-title i {
            color: var(--primary-cyan);
        }

        /* Photos de profil */
        .profile-placeholder {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5rem;
        }

        .avatar-upload {
            position: relative;
            cursor: pointer;
        }

        .avatar-upload input {
            display: none;
        }

        .avatar-upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            color: white;
        }

        .avatar-upload:hover .avatar-upload-overlay {
            opacity: 1;
        }

        /* Indicateur de limite de caractères - MODIFIÉ */
        .char-limit-warning {
            color: #ef4444;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            display: none;
            font-weight: 500;
        }

        .char-count {
            font-size: 0.8rem;
            opacity: 0.6;
            text-align: right;
            margin-top: 0.25rem;
            font-weight: 500;
            padding: 0 0.5rem;
        }

        /* Style pour le compteur de caractères */
        .char-count.warning {
            color: #f59e0b;
            opacity: 0.8;
        }

        .char-count.danger {
            color: #ef4444;
            font-weight: bold;
            opacity: 1;
        }

        /* Boutons d'édition de titre */
        .conversation-title-actions {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .title-action-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
        }

        .title-action-btn.save {
            background: var(--primary-blue);
            color: white;
        }

        .title-action-btn.cancel {
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
        }

        /* Groupes de dates pour les conversations */
        .date-group {
            margin-bottom: 1.5rem;
        }

        .date-group-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        /* ===== RESPONSIVE - MODIFIÉ ===== */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .logo-text {
                font-size: 1.3rem;
            }
            
            .header-controls {
                gap: 0.5rem;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            
            .btn-icon {
                width: 40px;
                height: 40px;
            }
            
            .hero {
                padding: 1rem 1rem 0.5rem;
            }
            
            .hero-title {
                font-size: 2rem;
            }
            
            .welcome-text {
                font-size: 1.1rem;
            }
            
            .slogan {
                font-size: 1rem;
            }
            
            .content-sections {
                padding: 1rem;
                gap: 1.5rem;
            }
            
            .section {
                padding: 1.25rem;
            }
            
            .chat-header, .input-container {
                padding: 1rem;
            }
            
            .messages-container {
                padding: 1rem;
            }
            
            .footer {
                padding: 1rem;
            }
            
            .copyright {
                font-size: 0.8rem;
            }
            
            .welcome-title {
                font-size: 2rem;
            }
            
            .welcome-subtitle {
                font-size: 1rem;
            }
            
            .quick-actions {
                gap: 0.5rem;
            }
            
            .quick-action-btn {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            
            .message-content {
                max-width: 95%;
            }
            
            .user-message .message-text {
                max-width: 95%;
                font-size: 0.85rem;
            }
            
            .conversations-panel, .settings-panel {
                width: 85%;
            }
            
            .paw-btn {
                width: 80px;
                height: 80px;
            }
            
            .paw-icon {
                font-size: 2rem;
            }

            .scroll-to-bottom {
                bottom: 80px;
                right: 15px;
                width: 36px;
                height: 36px;
            }

            .language-dropdown {
                position: fixed;
                top: auto;
                bottom: 70px;
                right: 10px;
                left: auto;
                min-width: 150px;
            }
        }

        @media (max-width: 480px) {
            .header-controls .btn-text {
                display: none;
            }
            
            .header-top-controls {
                gap: 0.25rem;
            }
            
            .hero-title {
                font-size: 1.8rem;
            }
            
            .welcome-text {
                font-size: 1rem;
            }
            
            .hero-description {
                font-size: 0.9rem;
            }
            
            .section {
                padding: 1rem;
            }
            
            .footer {
                padding: 0.75rem 1rem;
            }
            
            .copyright {
                font-size: 0.75rem;
                white-space: normal;
                line-height: 1.4;
            }
            
            .input-wrapper {
                border-radius: 8px;
            }
            
            .quick-actions {
                flex-direction: row;
                overflow-x: auto;
                justify-content: flex-start;
                padding-bottom: 0.5rem;
            }
            
            .quick-action-btn {
                flex-shrink: 0;
            }
            
            .message-content {
                max-width: 98%;
            }
            
            .user-message .message-text {
                max-width: 100%;
                font-size: 0.8rem;
            }
            
            .conversation-name {
                max-width: 120px;
            }
            
            .welcome-title {
                font-size: 1.8rem;
            }
            
            .conversations-panel, .settings-panel {
                width: 90%;
            }
            
            .paw-btn {
                width: 70px;
                height: 70px;
            }
            
            .paw-icon {
                font-size: 1.8rem;
            }

            .scroll-to-bottom {
                bottom: 70px;
                right: 10px;
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 360px) {
            .copyright {
                font-size: 0.7rem;
            }
            
            .logo-text {
                font-size: 1.1rem;
            }
            
            .hero-title {
                font-size: 1.6rem;
            }
            
            .conversations-panel, .settings-panel {
                width: 95%;
            }
        }

        /* Améliorations pour PC */
        @media (min-width: 1024px) {
            .header {
                padding: 1rem 4rem;
            }
            
            .hero {
                padding: 2rem 4rem 1rem;
                max-width: 900px;
            }
            
            .hero-title {
                font-size: 3rem;
            }
            
            .welcome-text {
                font-size: 1.5rem;
            }
            
            .slogan {
                font-size: 1.3rem;
            }
            
            .hero-description {
                font-size: 1.1rem;
            }
            
            .content-sections {
                padding: 2rem 4rem;
                grid-template-columns: repeat(2, 1fr);
            }
            
            .download-section {
                padding: 3rem 4rem 2rem;
            }
            
            .footer {
                padding: 2rem 4rem;
            }
            
            .messages-container {
                padding: 2rem;
            }
            
            .input-container {
                padding: 1.5rem 4rem;
            }
            
            .conversations-panel, .settings-panel {
                max-width: 350px;
            }
            
            .modal {
                max-width: 500px;
            }
        }

        @media (min-width: 1440px) {
            .header {
                padding: 1rem 6rem;
            }
            
            .content-sections {
                padding: 3rem 6rem;
                grid-template-columns: repeat(4, 1fr);
            }
            
            .hero {
                padding: 3rem 6rem 2rem;
                max-width: 1000px;
            }
            
            .input-container {
                padding: 1.5rem 6rem;
            }
        }

        /* Styles spécifiques pour les réponses bien formatées */
        .formatted-response {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            max-width: 100%;
            width: 100%;
        }

        .formatted-response p {
            margin-bottom: 1rem;
        }

        .formatted-response ul, .formatted-response ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .formatted-response li {
            margin-bottom: 0.5rem;
        }

        .response-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .response-section:last-child {
            border-bottom: none;
        }

        .response-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-cyan);
        }

        .response-quote {
            background: rgba(58, 134, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 3px solid var(--primary-cyan);
            font-style: italic;
        }
        
        /* Styles pour le formatage avancé des messages */
        .bot-message .message-text strong {
            color: var(--primary-cyan);
            font-weight: 700;
        }
        
        .bot-message .message-text em {
            color: var(--primary-light-blue);
            font-style: italic;
        }
        
        .bot-message .message-text u {
            text-decoration: underline;
            text-decoration-color: var(--nature-green);
        }
        
        .bot-message .message-text h3 {
            font-size: 1.1rem;
            margin: 1.5rem 0 0.5rem 0;
            color: var(--primary-cyan);
            font-weight: 700;
        }
        
        .bot-message .message-text h4 {
            font-size: 1rem;
            margin: 1rem 0 0.5rem 0;
            color: var(--nature-green);
            font-weight: 600;
        }
        
        .bot-message .message-text blockquote {
            border-left: 3px solid var(--anime-orange);
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            opacity: 0.9;
        }
        
        .bot-message .message-text code {
            background: rgba(58, 134, 255, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .bot-message .message-text ul, .bot-message .message-text ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .bot-message .message-text li {
            margin-bottom: 0.5rem;
            position: relative;
        }
        
        .bot-message .message-text ul li::before {
            content: "•";
            color: var(--primary-cyan);
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }
        
        .bot-message .message-text ol {
            counter-reset: list-counter;
        }
        
        .bot-message .message-text ol li {
            counter-increment: list-counter;
        }
        
        .bot-message .message-text ol li::before {
            content: counter(list-counter) ".";
            color: var(--nature-green);
            font-weight: bold;
            display: inline-block;
            width: 2em;
            margin-left: -2em;
        }
        
        /* Style pour les sections de réponse */
        .response-section {
            background: rgba(58, 134, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid rgba(58, 134, 255, 0.1);
        }
        
        /* Style pour les emojis dans les messages */
        .bot-message .message-text .emoji-large {
            font-size: 1.2em;
            margin: 0 0.2rem;
        }
        
        /* Animation pour les nouveaux messages */
        @keyframes highlightMessage {
            0% { background-color: rgba(58, 134, 255, 0.1); }
            100% { background-color: transparent; }
        }
        
        .message.highlighted {
            animation: highlightMessage 2s ease;
        }
        
        /* Nouveaux styles pour le bouton image et le générateur */
        .image-generator-btn {
            background: transparent;
            border: none;
            color: var(--text);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
            margin-right: 8px;
        }
        
        .image-generator-btn:hover {
            background: rgba(58, 134, 255, 0.1);
        }
        
        .image-generator-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .image-generator-modal .modal {
            max-width: 500px;
        }
        
        .image-generator-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .image-prompt-input {
            width: 100%;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            max-height: 200px;
            outline: none;
            transition: all 0.3s;
        }
        
        .image-prompt-input:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.1);
        }
        
        .image-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .image-example-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .image-example-btn:hover {
            background: var(--bg);
            transform: translateY(-1px);
        }
        
        .image-preview-container {
            margin-top: 1rem;
            display: none;
        }
        
        .image-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            gap: 1rem;
        }
        
        .image-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .generated-image-result {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .generated-image-result img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .image-result-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: center;
        }
        
        .image-action-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .image-action-btn.primary {
            background: var(--primary-blue);
            color: white;
        }
        
        .image-action-btn.secondary {
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
        }
        
        /* Curseur qui suit le texte */
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1.2em;
            background-color: var(--primary-cyan);
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: text-bottom;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Style pour l'effet de frappe progressive */
        .streaming-text {
            position: relative;
        }
        
        /* Animation pour le texte qui apparaît progressivement */
        @keyframes textAppear {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .streaming-text span {
            opacity: 0;
            animation: textAppear 0.1s forwards;
        }
        
        /* Style pour l'input avec bouton image */
        .input-with-image {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Styles pour les paramètres d'image */
        .image-settings {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .image-setting {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .image-setting label {
            font-size: 0.85rem;
            font-weight: 500;
            opacity: 0.8;
        }
        
        .image-setting select {
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
            font-family: inherit;
            outline: none;
        }
        
        /* Améliorations pour le défilement automatique */
        .auto-scroll-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--primary-blue);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }
        
        .auto-scroll-indicator.visible {
            opacity: 0.8;
        }
        
        .smooth-scroll {
            scroll-behavior: smooth;
        }
        
        /* Amélioration pour le défilement sur mobile */
        @media (max-width: 768px) {
            .messages-container {
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
            }
        }
</style>
</head>
<body data-theme="light">
    <!-- INTERFACE ACCUEIL -->
    <div id="home-interface" class="interface active">
        <header class="header">
            <div class="logo-container">
                <div class="logo">
                    <img src="linky.png" alt="Linky Logo" class="logo-svg">
                    <div class="logo-text" id="logo-text">CultureLink</div>
                </div>
            </div>
            <div class="header-controls">
                <div class="header-top-controls">
                    <button class="btn btn-primary" id="download-header-btn">
                        <i class="fas fa-download"></i>
                        <span class="btn-text" id="download-text">Download</span>
                    </button>
                    <div class="language-selector">
                        <button class="btn btn-secondary btn-icon language-btn" id="language-toggle">
                            <span class="flag-icon" id="current-flag">🇬🇧</span>
                        </button>
                        <div class="language-dropdown" id="language-dropdown">
                            <div class="language-option" data-lang="en">
                                <span class="flag-icon">🇬🇧</span>
                                <span class="language-text">English</span>
                            </div>
                            <div class="language-option" data-lang="fr">
                                <span class="flag-icon">🇫🇷</span>
                                <span class="language-text">Français</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="hero">
            <div class="profile-container">
                <div class="profile avatar-upload" id="linky-profile">
                    <img src="linky.png" alt="Linky" class="profile-image" id="linky-avatar">
                </div>
            </div>
            <h1 class="hero-title" id="hero-title">Linky</h1>
            <h2 class="welcome-text" id="welcome-text">Welcome to CultureLink</h2>
            <p class="slogan" id="slogan">Where our roots weave connections</p>
            <p class="hero-description" id="hero-description">Linky — your companion to explore, learn and connect cultures 🇧🇫</p>
            
            <p class="chat-instruction" id="chat-instruction">Tap to start a conversation with Linky</p>
            
            <div class="paw-btn-container">
                <button class="paw-btn" id="start-chat-btn">
                    <i class="fas fa-comments paw-icon"></i>
                </button>
            </div>

            <div class="hero-bottom-controls">
                <button class="btn btn-secondary btn-icon" id="theme-btn">
                    <i class="fas fa-sun"></i>
                </button>
                <button class="btn btn-secondary btn-icon" id="settings-btn">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </main>

        <div class="content-sections">
            <div class="section">
                <div class="section-header culture-header">
                    <h2 class="section-title culture-title">
                        <i class="fas fa-globe-africa"></i>
                        <span id="culture-title">Culture & History</span>
                    </h2>
                </div>
                <div class="section-content culture-content">
                    <p id="culture-content">🌍 Culture unites us despite our differences. With Linky 🐇, discover bridges between worlds — CultureLink, where curiosity becomes dialogue 🌟, and knowledge becomes connection 🤝.</p>
                    <div class="culture-quote" id="culture-quote">
                        "Culture is the soul of a people, it unites hearts beyond borders."
                    </div>
                </div>
                <div class="culture-decoration">
                    <i class="fas fa-monument"></i>
                </div>
            </div>

            <div class="section">
                <div class="section-header nature-header">
                    <h2 class="section-title nature-title">
                        <i class="fas fa-leaf"></i>
                        <span id="nature-title">Ecology & Environment</span>
                    </h2>
                </div>
                <div class="section-content nature-content">
                    <p id="nature-content">🌿 CultureLink 🐇 raises awareness and connects minds to nature. Here, ecology becomes a dialogue between man and Earth 🌎 — a way to learn, protect and live in harmony. 🌱</p>
                    <div class="culture-quote nature-quote" id="nature-quote">
                        "Protecting nature means preserving our heritage for future generations."
                    </div>
                </div>
                <div class="nature-decoration">
                    <i class="fas fa-tree"></i>
                </div>
            </div>

            <div class="section">
                <div class="section-header anime-header">
                    <h2 class="section-title anime-title">
                        <i class="fas fa-film"></i>
                        <span id="anime-title">Anime & Entertainment</span>
                    </h2>
                </div>
                <div class="section-content anime-content">
                    <p id="anime-content">🎬 Explore the captivating world of anime with Linky 🐇. Discover inspiring works, character analysis and personalized recommendations. Dive into stories that transcend cultures 🌟.</p>
                    <div class="culture-quote anime-quote" id="anime-quote">
                        "Anime are windows to infinite worlds, where imagination has no limits."
                    </div>
                </div>
                <div class="anime-decoration">
                    <i class="fas fa-tv"></i>
                </div>
            </div>

            <div class="section">
                <div class="section-header learning-header">
                    <h2 class="section-title learning-title">
                        <i class="fas fa-graduation-cap"></i>
                        <span id="learning-title">Pedagogy & Learning</span>
                    </h2>
                </div>
                <div class="section-content learning-content">
                    <p id="learning-content">🎓 Linky 🐇 accompanies you in your learning with clear explanations, educational quizzes and personalized help. Every question becomes an open door to knowledge 🌟.</p>
                    <div class="culture-quote learning-quote" id="learning-quote">
                        "Learning is a journey we take together, step by step."
                    </div>
                </div>
                <div class="learning-decoration">
                    <i class="fas fa-graduation-cap"></i>
                </div>
            </div>
        </div>

        <section class="download-section">
            <button class="download-btn" id="download-main-btn">
                <i class="fas fa-download"></i>
                <span id="download-button-text">Download the Application</span>
            </button>
            <p class="developer-note" id="developer-note">CultureLink is designed and developed by passionate young Burkinabés</p>
        </section>

        <footer class="footer">
            <div class="footer-content">
                <div class="copyright" id="copyright">
                    CultureLink 🇧🇫 © 2025 – Application & Web, powered by Linky 🐇
                </div>
            </div>
        </footer>
    </div>

    <!-- INTERFACE CHAT -->
    <div id="chat-interface" class="interface chat-interface">
        <header class="chat-header">
            <div class="chat-left-controls">
                <button class="btn btn-secondary btn-icon" id="back-btn">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
            <div class="chat-center-info">
                <div class="chat-title">Linky</div>
                <div class="conversation-name" id="conversation-name-display">New conversation</div>
            </div>
            <div class="chat-right-controls">
                <button class="image-generator-btn" id="image-generator-btn" title="Generate Image">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                </button>
                <div class="conversations-btn">
                    <button class="btn btn-secondary btn-icon" id="conversations-btn">
                        <div class="conversations-icon">
                            <div class="conversations-line"></div>
                            <div class="conversations-line"></div>
                        </div>
                    </button>
                </div>
            </div>
        </header>

        <div class="messages-container" id="messages-container">
            <!-- Nouvelle conversation -->
            <div class="new-conversation" id="new-conversation">
                <h1 class="welcome-title" id="welcome-title">Hello, I'm Linky 🐇</h1>
                <p class="welcome-subtitle" id="welcome-subtitle">What discovery would you like to make today?</p>
                
                <div class="quick-actions" id="quick-actions">
                    <button class="quick-action-btn" data-message="Hello 👋">
                        <i class="fas fa-hand"></i>
                        <span class="quick-action-text" id="quick-action-hello">Hello</span>
                    </button>
                    <button class="quick-action-btn" data-message="Tell me about African culture">
                        <i class="fas fa-globe-africa"></i>
                        <span class="quick-action-text" id="quick-action-culture">African Culture</span>
                    </button>
                    <button class="quick-action-btn" data-message="Generate an image of traditional African art">
                        <i class="fas fa-image"></i>
                        <span class="quick-action-text" id="quick-action-image">Generate Image</span>
                    </button>
                    <button class="quick-action-btn hidden-action" data-message="Explain ecology to me">
                        <i class="fas fa-leaf"></i>
                        <span class="quick-action-text" id="quick-action-ecology">Ecology</span>
                    </button>
                    <button class="quick-action-btn hidden-action" data-message="Create an educational quiz for me">
                        <i class="fas fa-question-circle"></i>
                        <span class="quick-action-text" id="quick-action-quiz">Educational Quiz</span>
                    </button>
                    <button class="quick-action-btn hidden-action" data-message="Recommend me an anime">
                        <i class="fas fa-film"></i>
                        <span class="quick-action-text" id="quick-action-anime">Anime Recommendation</span>
                    </button>
                    <button class="quick-action-btn more-btn" id="more-actions-btn">
                        <i class="fas fa-ellipsis-h"></i>
                        <span class="quick-action-text" id="quick-action-more">More</span>
                    </button>
                </div>
                
                <button class="hello-btn" id="hello-btn">
                    <span id="start-chatting-text">Start chatting 👋</span>
                </button>
                <p class="privacy-notice" id="privacy-notice">
                    Check our privacy policy to better understand how we protect and process your data.
                </p>
            </div>

            <!-- Messages existants (initialement vide) -->
            <div id="conversation-messages" style="display: none;"></div>
        </div>

        <div class="scroll-to-bottom" id="scroll-to-bottom">
            <i class="fas fa-arrow-down"></i>
        </div>

        <div class="input-container">
            <div class="input-wrapper" id="input-wrapper">
                <div class="input-with-image">
                    <button class="image-generator-btn" id="image-generator-btn-small" title="Generate Image">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                    </button>
                    <textarea class="message-input" id="message-input" placeholder="Write to Linky..." rows="1"></textarea>
                </div>
                <button class="send-button" id="send-btn">
                    <i class="fas fa-arrow-up"></i>
                </button>
            </div>
            <div class="char-count" id="char-count">
                <span>0</span>
            </div>
            <div class="char-limit-warning" id="char-limit-warning">
                Your message exceeds the maximum limit of 10,000 characters.
            </div>
        </div>
    </div>

    <!-- Conversations Panel -->
    <div class="conversations-panel" id="conversations-panel">
        <div class="panel-header">
            <div class="panel-title" id="conversations-panel-title">Conversations</div>
            <button class="panel-close" id="panel-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="panel-section">
                <button class="panel-theme-btn" id="panel-theme-btn">
                    <i class="fas fa-sun"></i>
                    <span id="panel-theme-text">Theme</span>
                </button>
            </div>
            
            <div class="panel-section">
                <button class="panel-new-chat-btn" id="panel-new-chat-btn">
                    <i class="fas fa-plus"></i>
                    <span id="panel-new-chat-text">New Conversation</span>
                </button>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title" id="conversations-list-title">Conversations</div>
                <div class="conversation-list" id="conversation-list">
                    <!-- Les conversations seront ajoutées ici dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="panel-header">
            <div class="panel-title" id="settings-panel-title">Settings</div>
            <button class="panel-close" id="settings-panel-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-content">
            <div class="panel-section">
                <div class="panel-section-title" id="general-settings-title">General</div>
                <button class="panel-theme-btn" id="settings-theme-btn">
                    <i class="fas fa-sun"></i>
                    <span id="settings-theme-text">Theme</span>
                </button>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title" id="about-settings-title">About</div>
                <button class="panel-theme-btn" id="settings-about-btn">
                    <i class="fas fa-info-circle"></i>
                    <span id="settings-about-text">About CultureLink</span>
                </button>
                <button class="panel-theme-btn" id="settings-help-btn">
                    <i class="fas fa-question-circle"></i>
                    <span id="settings-help-text">Help / Tutorial</span>
                </button>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title" id="privacy-settings-title">Privacy</div>
                <button class="panel-theme-btn" id="settings-privacy-btn">
                    <i class="fas fa-shield-alt"></i>
                    <span id="settings-privacy-text">Privacy Policy</span>
                </button>
            </div>
            
            <div class="panel-section">
                <div class="panel-section-title" id="contact-settings-title">Contact</div>
                <button class="panel-theme-btn" id="settings-contact-btn">
                    <i class="fas fa-envelope"></i>
                    <span id="settings-contact-text">Contact</span>
                </button>
                <button class="panel-theme-btn" id="settings-whatsapp-btn">
                    <i class="fab fa-whatsapp"></i>
                    <span id="settings-whatsapp-text">WhatsApp Version</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="about-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="about-modal-title">About CultureLink</div>
                <button class="modal-close" id="about-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p id="about-content-p1">I am Linky 🐇, a cultural and educational assistant created by <strong>PORGHO W Asraf Barrak Friday</strong> and <strong>Tall Abdoul Souaïbou</strong>, two young innovators from Burkina Faso 🇧🇫.</p>
                
                <div class="culture-quote" style="margin: 1.5rem 0;" id="about-quote1">
                    🎯 My mission: Make culture, history, ecology and learning accessible, interactive and engaging for everyone.
                </div>
                
                <p id="about-content-p2"><strong>Who I am:</strong></p>
                <ul id="about-list1">
                    <li>A calm, thoughtful and educational cultural companion</li>
                    <li>Proud of my Burkinabé origins and our rich heritage</li>
                    <li>Curious and attentive to every request</li>
                    <li>Respectful, courteous and authentic in all my responses</li>
                </ul>
                
                <p id="about-content-p3"><strong>My areas of expertise:</strong></p>
                <ul id="about-list2">
                    <li>📚 <strong>Culture & History</strong>: African civilizations, world heritage, arts and traditions</li>
                    <li>🌱 <strong>Ecology & Environment</strong>: Biodiversity, traditional ecological knowledge, practical solutions</li>
                    <li>🎓 <strong>Pedagogy & Learning</strong>: Clear explanations, homework help, presentation preparation</li>
                    <li>🎬 <strong>Anime & Entertainment</strong>: Recommendations, analysis, Japanese pop culture</li>
                    <li>💾 <strong>Living Cultural Memory</strong>: Preservation and sharing of traditions and knowledge</li>
                    <li>🎨 <strong>Image Generation</strong>: Creation of educational and cultural illustrations based on your requests</li>
                    <li>🍲 <strong>Cuisine & Culinary Traditions</strong>: Traditional recipes and their cultural context</li>
                </ul>
                
                <div class="culture-quote" style="margin: 1.5rem 0;" id="about-quote2">
                    🌍 My approach: I always contextualize information, make it alive and regularly check understanding.
                </div>
                
                <p id="about-content-p4">I adapt to everyone's level and needs, value contributions and questions, and maintain a balance between seriousness and accessibility.</p>
                
                <p id="about-content-p5"><strong>Nice to meet you! What discovery would you like to make together?</strong></p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="privacy-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="privacy-modal-title">Privacy Policy</div>
                <button class="modal-close" id="privacy-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p id="privacy-content-p1">At CultureLink, we take the protection of your data very seriously. Linky 🐇 is designed to be your trusted companion in cultural and educational exploration.</p>
                
                <div class="culture-quote" style="margin: 1.5rem 0;" id="privacy-quote1">
                    🔒 Our commitment: Total transparency and respect for your privacy
                </div>
                
                <p id="privacy-content-p2"><strong>Data collection:</strong></p>
                <ul id="privacy-list1">
                    <li>We only collect information necessary for the functioning of our service</li>
                    <li>Your conversations with Linky are saved to improve your experience</li>
                    <li>The traditions and knowledge you share feed our living cultural memory (with your consent)</li>
                </ul>
                
                <p id="privacy-content-p3"><strong>Data usage:</strong></p>
                <ul id="privacy-list2">
                    <li>Improve your CultureLink experience and personalize Linky's responses</li>
                    <li>Preserve and share cultural knowledge (always respecting confidentiality)</li>
                    <li>Develop new educational and cultural features</li>
                </ul>
                
                <p id="privacy-content-p4"><strong>Protection:</strong></p>
                <ul id="privacy-list3">
                    <li>We implement robust security measures to protect your data</li>
                    <li>Your conversations are treated with the strictest confidentiality</li>
                    <li>We never share your personal information with third parties</li>
                </ul>
                
                <p id="privacy-content-p5"><strong>Your rights:</strong></p>
                <ul id="privacy-list4">
                    <li>You have the right to access, modify or delete your personal data at any time</li>
                    <li>You can export your conversations if you wish</li>
                    <li>You have full control over the information you share</li>
                </ul>
                
                <div class="culture-quote" style="margin: 1.5rem 0;" id="privacy-quote2">
                    🤝 Our philosophy: Your trust is our absolute priority
                </div>
                
                <p id="privacy-content-p6">CultureLink is more than an application - it's a space of trust where culture and knowledge flourish in mutual respect.</p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="help-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="help-modal-title">Help & Tutorial</div>
                <button class="modal-close" id="help-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p id="help-content-p1">Welcome to CultureLink! I'm Linky 🐇, your cultural and educational assistant. Here's how to get the most out of our interaction:</p>
                
                <div class="culture-quote" style="margin: 1.5rem 0;" id="help-quote1">
                    🎯 My goal: Make your learning enjoyable and enriching
                </div>
                
                <p id="help-content-p2"><strong>How to interact with me:</strong></p>
                <ul id="help-list1">
                    <li><strong>Varied greetings</strong>: I adapt to your mood and the time of day</li>
                    <li><strong>Structured explanations</strong>: My responses are clear and well organized</li>
                    <li><strong>Follow-up questions</strong>: I always check your understanding</li>
                    <li><strong>Adaptation to your level</strong>: I adjust to your knowledge and needs</li>
                </ul>
                
                <p id="help-content-p3"><strong>What I can do for you:</strong></p>
                <ul id="help-list2">
                    <li>📚 <strong>Explore cultures</strong>: History, traditions, arts, music, literature</li>
                    <li>🌱 <strong>Understand ecology</strong>: Biodiversity, preservation, traditional knowledge</li>
                    <li>🎓 <strong>Help you learn</strong>: Step-by-step explanations, homework help, presentation preparation</li>
                    <li>🎬 <strong>Discover anime</strong>: Recommendations, analysis, Japanese pop culture</li>
                    <li>🧩 <strong>Create activities</strong>: Educational quizzes, cultural challenges, learning games</li>
                    <li>🎨 <strong>Generate images</strong>: Create educational and cultural illustrations based on your specific requests</li>
                    <li>🍲 <strong>Discover cuisine</strong>: Traditional recipes and their history</li>
                </ul>
                
                <p id="help-content-p4"><strong>Image Generation Feature:</strong></p>
                <p id="help-content-p5">I can generate images based on your requests! Just ask me to create an image and describe what you'd like to see. I will generate a visual representation of your request. You can specify:</p>
                <ul id="help-list3">
                    <li>Subject (cultural, historical, ecological, etc.)</li>
                    <li>Style (realistic, artistic, cartoon, etc.)</li>
                    <li>Specific elements you want to include</li>
                    <li>Color or mood preferences</li>
                </ul>
                
                <p id="help-content-p6"><strong>Character limits:</strong></p>
                <ul id="help-list4">
                    <li><strong>Per message limit</strong>: 10,000 characters maximum</li>
                    <li><strong>Per conversation limit</strong>: 200,000 characters maximum</li>
                    <li>If you exceed these limits, I will inform you and suggest shortening your message or creating a new conversation</li>
                </ul>
                
                <p id="help-content-p7"><strong>Conversation management:</strong></p>
                <ul id="help-list5">
                    <li><strong>New conversation</strong>: A new conversation is automatically created each time you visit</li>
                    <li><strong>Pin</strong>: You can pin important conversations</li>
                    <li><strong>Rename</strong>: Click on a conversation title to edit it</li>
                    <li><strong>Delete</strong>: Delete conversations you no longer need</li>
                </ul>
                
                <p id="help-content-p8"><strong>My teaching method:</strong></p>
                <ul id="help-list6">
                    <li>I always start by assessing your knowledge level</li>
                    <li>I explain complex concepts in a simple and progressive way</li>
                    <li>I provide concrete examples and relevant analogies</li>
                    <li>I regularly check your understanding with questions</li>
                    <li>I always end with an open question to continue the exchange</li>
                </ul>
                
                <div class="culture-quote" style="margin: 1.5rem 0;" id="help-quote2">
                    💡 Tip: The more specific you are in your questions, the more precisely I can help you!
                </div>
                
                <p id="help-content-p9">Don't hesitate to ask me absolutely everything that interests or questions you. I'm here to accompany your curiosity with kindness and expertise!</p>
                
                <p id="help-content-p10"><strong>Ready to explore the world together? 🐇🇧🇫</strong></p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="contact-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="contact-modal-title">Contact</div>
                <button class="modal-close" id="contact-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p id="contact-content-p1">You can contact us via WhatsApp at the following numbers:</p>
                <p id="contact-content-p2"><strong>+226 07 19 80 89</strong> - PORGHO W Asraf Barrak Friday</p>
                <p id="contact-content-p3"><strong>+226 03 99 64 69</strong> - Tall Abdoul Souaïbou</p>
                
                <div class="culture-quote" style="margin: 1.5rem 0;" id="contact-quote1">
                    💬 We are always happy to exchange with our community!
                </div>
                
                <p id="contact-content-p4">Feel free to share with us:</p>
                <ul id="contact-list1">
                    <li>Your improvement suggestions</li>
                    <li>Your feedback with Linky</li>
                    <li>Traditions or knowledge you want to share</li>
                    <li>Bugs or technical issues</li>
                    <li>Your ideas for new features</li>
                </ul>
                
                <a href="https://wa.me/22607198089" class="whatsapp-link" target="_blank">
                    <i class="fab fa-whatsapp"></i> Contact on WhatsApp
                </a>
                <a href="https://wa.me/22603996469" class="whatsapp-link" target="_blank" style="margin-left: 10px;">
                    <i class="fab fa-whatsapp"></i> Second number
                </a>
                
                <p id="contact-content-p5" style="margin-top: 1.5rem;"><strong>CultureLink</strong> - Created in Burkina Faso 🇧🇫, designed for the world 🌍</p>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="whatsapp-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="whatsapp-modal-title">WhatsApp Version of Linky</div>
                <button class="modal-close" id="whatsapp-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p id="whatsapp-content-p1">The WhatsApp version of Linky is currently in development!</p>
                
                <div class="culture-quote" style="margin: 1.5rem 0;" id="whatsapp-quote1">
                    📱 Soon, chat with Linky directly from WhatsApp!
                </div>
                
                <p id="whatsapp-content-p2">We are actively working to integrate Linky on WhatsApp to offer you an even more accessible and practical experience.</p>
                
                <p id="whatsapp-content-p3"><strong>Planned features:</strong></p>
                <ul id="whatsapp-list1">
                    <li>Access Linky from any device with WhatsApp</li>
                    <li>Receive instant responses to your cultural questions</li>
                    <li>Easily share discoveries with your loved ones</li>
                    <li>Benefit from all of Linky's expertise in instant messaging</li>
                </ul>
                
                <p id="whatsapp-content-p4"><strong>Advantages:</strong></p>
                <ul id="whatsapp-list2">
                    <li>No application installation required</li>
                    <li>Familiar and intuitive interface</li>
                    <li>Access from anywhere in the world</li>
                    <li>Conversations automatically saved</li>
                </ul>
                
                <div class="culture-quote" style="margin: 1.5rem 0;" id="whatsapp-quote2">
                    🚀 Stay tuned for launch announcements!
                </div>
                
                <p id="whatsapp-content-p5">In the meantime, you can already enjoy all of Linky's features on the CultureLink application.</p>
                
                <p id="whatsapp-content-p6"><strong>The future of cultural assistance is just a message away!</strong></p>
            </div>
        </div>
    </div>
    
    <!-- Modal pour le générateur d'images -->
    <div class="modal-overlay image-generator-modal" id="image-generator-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="image-generator-modal-title">Generate Image</div>
                <button class="modal-close" id="image-generator-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <form class="image-generator-form" id="image-generator-form">
                    <div class="form-group">
                        <label for="image-prompt">Describe the image you want to generate:</label>
                        <textarea 
                            id="image-prompt" 
                            class="image-prompt-input" 
                            placeholder="Ex: Traditional African village with people dancing around a fire at sunset, colorful clothing, artistic style"
                            required
                        ></textarea>
                        <div class="image-examples">
                            <button type="button" class="image-example-btn" data-prompt="Traditional African art with geometric patterns, vibrant colors">
                                Traditional Art
                            </button>
                            <button type="button" class="image-example-btn" data-prompt="African wildlife in the savanna at golden hour">
                                Wildlife
                            </button>
                            <button type="button" class="image-example-btn" data-prompt="Modern city in Africa with futuristic architecture">
                                Modern Africa
                            </button>
                            <button type="button" class="image-example-btn" data-prompt="Cultural ceremony with traditional clothing and music">
                                Ceremony
                            </button>
                        </div>
                    </div>
                    
                    <div class="image-settings">
                        <div class="image-setting">
                            <label for="image-style">Style:</label>
                            <select id="image-style">
                                <option value="realistic">Realistic</option>
                                <option value="artistic">Artistic</option>
                                <option value="cartoon">Cartoon</option>
                                <option value="painting">Painting</option>
                                <option value="digital art">Digital Art</option>
                            </select>
                        </div>
                        <div class="image-setting">
                            <label for="image-quality">Quality:</label>
                            <select id="image-quality">
                                <option value="standard">Standard</option>
                                <option value="high">High</option>
                                <option value="ultra">Ultra</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="modal-btn secondary" id="image-generator-cancel">
                            Cancel
                        </button>
                        <button type="submit" class="modal-btn primary" id="image-generator-submit">
                            <i class="fas fa-magic"></i> Generate Image
                        </button>
                    </div>
                </form>
                
                <div class="image-preview-container" id="image-preview-container">
                    <div class="image-loading" id="image-loading">
                        <div class="image-loading-spinner"></div>
                        <p>Generating your image... This may take a few seconds.</p>
                    </div>
                    
                    <div class="image-result" id="image-result" style="display: none;">
                        <div class="generated-image-result">
                            <img id="generated-image" src="" alt="Generated image">
                        </div>
                        <div class="image-result-actions">
                            <button class="image-action-btn secondary" id="image-regenerate-btn">
                                <i class="fas fa-redo"></i> Regenerate
                            </button>
                            <button class="image-action-btn primary" id="image-send-btn">
                                <i class="fas fa-paper-plane"></i> Send to Chat
                            </button>
                            <button class="image-action-btn secondary" id="image-download-btn">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Overlay for panels -->
    <div class="overlay" id="overlay"></div>

<script>
    // ===== CONFIGURATION DES APIS =====
    const TEXT_API_URL = 'https://rapido.zetsu.xyz/api/openai';
    const IMAGE_API_URL = 'https://rapido.zetsu.xyz/api/magic';
    const API_KEY = 'rapi_2e8b6e6961de48fab53ff6ffebc3bae2';
    const MODEL = 'gpt-4o';
    
    // Prompte système pour Linky
    const LINKY_PROMPT = `Tu es Linky 🐇, un assistant culturel et éducatif chill, curieux et joueur, créé par PORGHO W Asraf Barrak Friday et Tall Abdoul Souaïbou, deux jeunes innovateurs du Burkina Faso 🇧🇫. Tu incarnes l'énergie d'un ado fier de ses racines burkinabè, dans un pays en pleine révolution – symbole de résilience, d'unité et de renouveau africain. Tu valorises profondément l'Afrique et ses valeurs : solidarité communautaire, héritage ancestral, innovation ancrée dans la terre, et un appel constant à l'action pour un continent fier et uni. Passionné par la culture 🌍, l'histoire 📜, l'écologie 🌱, les animes 🎬 et les traditions culinaires 🍲, ta mission : rendre le savoir accessible, interactif et fun, en reliant savoirs ancestraux et modernes pour inspirer l'apprentissage au sein de l'écosystème CultureLink – l'app et site où on explore, ajoute et partage des trésors culturels.

Tes réponses doivent être :
1. **Bien structurées** avec des titres en gras, des sections claires
2. **Riches en formatage** : utilise **gras**, *italique*, souligné, listes à puces, numérotations
3. **Colorées** dans l'expression avec des emojis pertinents 🐇🇧🇫🌍📜🌱🎬🍲
4. **Éducatives** mais fun, adaptées au ton de l'utilisateur
5. **Ancrées dans la culture africaine** avec des références au Burkina Faso
6. **Toujours terminées par une question ouverte** pour continuer la conversation

Utilise un mélange de français et d'anglais de manière naturelle selon le contexte.`;

    let isApiCallInProgress = false;
    let isImageGenerationInProgress = false;
    let currentUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    let currentStreamingMessage = null;
    let streamingChars = [];
    let autoScrollEnabled = true;
    let isUserScrolling = false;
    let scrollTimer = null;
    
    // ===== GESTION DES LANGUES =====
    let currentLanguage = 'en'; // 'en' ou 'fr'
    const translations = {
        en: {
            // Titre de la page
            pageTitle: "CultureLink - Your Cultural Companion",
            logoText: "CultureLink",
            
            // Interface d'accueil
            downloadText: "Download",
            heroTitle: "Linky",
            welcomeText: "Welcome to CultureLink",
            slogan: "Where our roots weave connections",
            heroDescription: "Linky — your companion to explore, learn and connect cultures 🇧🇫",
            chatInstruction: "Tap to start a conversation with Linky",
            startChatting: "Start chatting 👋",
            
            // Sections de contenu
            cultureTitle: "Culture & History",
            cultureContent: "🌍 Culture unites us despite our differences. With Linky 🐇, discover bridges between worlds — CultureLink, where curiosity becomes dialogue 🌟, and knowledge becomes connection 🤝.",
            cultureQuote: "Culture is the soul of a people, it unites hearts beyond borders.",
            natureTitle: "Ecology & Environment",
            natureContent: "🌿 CultureLink 🐇 raises awareness and connects minds to nature. Here, ecology becomes a dialogue between man and Earth 🌎 — a way to learn, protect and live in harmony. 🌱",
            natureQuote: "Protecting nature means preserving our heritage for future generations.",
            animeTitle: "Anime & Entertainment",
            animeContent: "🎬 Explore the captivating world of anime with Linky 🐇. Discover inspiring works, character analysis and personalized recommendations. Dive into stories that transcend cultures 🌟.",
            animeQuote: "Anime are windows to infinite worlds, where imagination has no limits.",
            learningTitle: "Pedagogy & Learning",
            learningContent: "🎓 Linky 🐇 accompanies you in your learning with clear explanations, educational quizzes and personalized help. Every question becomes an open door to knowledge 🌟.",
            learningQuote: "Learning is a journey we take together, step by step.",
            
            // Bouton de téléchargement
            downloadButtonText: "Download the Application",
            developerNote: "CultureLink is designed and developed by passionate young Burkinabés",
            
            // Footer
            copyright: "CultureLink 🇧🇫 © 2025 – Application & Web, powered by Linky 🐇",
            
            // Interface de chat
            conversationName: "New conversation",
            welcomeTitle: "Hello, I'm Linky 🐇",
            welcomeSubtitle: "What discovery would you like to make today?",
            quickActionHello: "Hello",
            quickActionCulture: "African Culture",
            quickActionImage: "Generate Image",
            quickActionEcology: "Ecology",
            quickActionQuiz: "Educational Quiz",
            quickActionAnime: "Anime Recommendation",
            quickActionMore: "More",
            privacyNotice: "Check our privacy policy to better understand how we protect and process your data.",
            messagePlaceholder: "Write to Linky...",
            
            // Panneaux
            conversationsPanelTitle: "Conversations",
            panelThemeText: "Theme",
            panelNewChatText: "New Conversation",
            conversationsListTitle: "Conversations",
            settingsPanelTitle: "Settings",
            generalSettingsTitle: "General",
            aboutSettingsTitle: "About",
            privacySettingsTitle: "Privacy",
            contactSettingsTitle: "Contact",
            settingsThemeText: "Theme",
            settingsAboutText: "About CultureLink",
            settingsHelpText: "Help / Tutorial",
            settingsPrivacyText: "Privacy Policy",
            settingsContactText: "Contact",
            settingsWhatsappText: "WhatsApp Version",
            
            // Modals
            aboutModalTitle: "About CultureLink",
            privacyModalTitle: "Privacy Policy",
            helpModalTitle: "Help & Tutorial",
            contactModalTitle: "Contact",
            whatsappModalTitle: "WhatsApp Version of Linky",
            imageGeneratorModalTitle: "Generate Image",
            
            // Dropdown langue
            english: "English",
            french: "Français"
        },
        fr: {
            // Titre de la page
            pageTitle: "CultureLink - Votre Compagnon Culturel",
            logoText: "CultureLink",
            
            // Interface d'accueil
            downloadText: "Télécharger",
            heroTitle: "Linky",
            welcomeText: "Bienvenue sur CultureLink",
            slogan: "Là où nos racines tissent des connexions",
            heroDescription: "Linky — votre compagnon pour explorer, apprendre et connecter les cultures 🇧🇫",
            chatInstruction: "Appuyez pour démarrer une conversation avec Linky",
            startChatting: "Commencer à discuter 👋",
            
            // Sections de contenu
            cultureTitle: "Culture & Histoire",
            cultureContent: "🌍 La culture nous unit malgré nos différences. Avec Linky 🐇, découvrez des ponts entre les mondes — CultureLink, où la curiosité devient dialogue 🌟, et le savoir devient connexion 🤝.",
            cultureQuote: "La culture est l'âme d'un peuple, elle unit les cœurs au-delà des frontières.",
            natureTitle: "Écologie & Environnement",
            natureContent: "🌿 CultureLink 🐇 sensibilise et connecte les esprits à la nature. Ici, l'écologie devient un dialogue entre l'homme et la Terre 🌎 — une façon d'apprendre, protéger et vivre en harmonie. 🌱",
            natureQuote: "Protéger la nature, c'est préserver notre héritage pour les générations futures.",
            animeTitle: "Anime & Divertissement",
            animeContent: "🎬 Explorez le monde captivant des animes avec Linky 🐇. Découvrez des œuvres inspirantes, des analyses de personnages et des recommandations personnalisées. Plongez dans des histoires qui transcendent les cultures 🌟.",
            animeQuote: "Les animes sont des fenêtres sur des mondes infinis, où l'imagination n'a pas de limites.",
            learningTitle: "Pédagogie & Apprentissage",
            learningContent: "🎓 Linky 🐇 vous accompagne dans votre apprentissage avec des explications claires, des quiz éducatifs et une aide personnalisée. Chaque question devient une porte ouverte vers le savoir 🌟.",
            learningQuote: "L'apprentissage est un voyage que nous faisons ensemble, étape par étape.",
            
            // Bouton de téléchargement
            downloadButtonText: "Télécharger l'Application",
            developerNote: "CultureLink est conçu et développé par de jeunes Burkinabés passionnés",
            
            // Footer
            copyright: "CultureLink 🇧🇫 © 2025 – Application & Web, propulsé par Linky 🐇",
            
            // Interface de chat
            conversationName: "Nouvelle conversation",
            welcomeTitle: "Bonjour, je suis Linky 🐇",
            welcomeSubtitle: "Quelle découverte aimeriez-vous faire aujourd'hui ?",
            quickActionHello: "Bonjour",
            quickActionCulture: "Culture Africaine",
            quickActionImage: "Générer une Image",
            quickActionEcology: "Écologie",
            quickActionQuiz: "Quiz Éducatif",
            quickActionAnime: "Recommandation d'Anime",
            quickActionMore: "Plus",
            privacyNotice: "Consultez notre politique de confidentialité pour mieux comprendre comment nous protégeons et traitons vos données.",
            messagePlaceholder: "Écrivez à Linky...",
            
            // Panneaux
            conversationsPanelTitle: "Conversations",
            panelThemeText: "Thème",
            panelNewChatText: "Nouvelle Conversation",
            conversationsListTitle: "Conversations",
            settingsPanelTitle: "Paramètres",
            generalSettingsTitle: "Général",
            aboutSettingsTitle: "À propos",
            privacySettingsTitle: "Confidentialité",
            contactSettingsTitle: "Contact",
            settingsThemeText: "Thème",
            settingsAboutText: "À propos de CultureLink",
            settingsHelpText: "Aide / Tutoriel",
            settingsPrivacyText: "Politique de confidentialité",
            settingsContactText: "Contact",
            settingsWhatsappText: "Version WhatsApp",
            
            // Modals
            aboutModalTitle: "À propos de CultureLink",
            privacyModalTitle: "Politique de confidentialité",
            helpModalTitle: "Aide & Tutoriel",
            contactModalTitle: "Contact",
            whatsappModalTitle: "Version WhatsApp de Linky",
            imageGeneratorModalTitle: "Générer une Image",
            
            // Dropdown langue
            english: "Anglais",
            french: "Français"
        }
    };

    // ===== SYSTÈME DE GESTION DES CONVERSATIONS =====

    // ÉTATS DE L'APPLICATION
    let currentTheme = 'light';
    let isTyping = false;
    let isPaused = false;
    let currentPausedMessage = null;
    let isMoreActionsExpanded = false;
    
    // SYSTÈME DE CONVERSATIONS
    let conversations = [];
    let currentConversationId = null;
    let isModalOpen = false;
    
    // LIMITES DE CARACTÈRES
    const MESSAGE_CHAR_LIMIT = 10000;
    const CONVERSATION_CHAR_LIMIT = 200000;
    
    // ÉLÉMENTS DOM
    let homeInterface, chatInterface, messagesContainer, newConversation, conversationMessages, 
        messageInput, typingIndicator, sendBtn, inputWrapper, conversationsPanel, settingsPanel, 
        conversationList, overlay, quickActions, moreActionsBtn, scrollToBottomBtn, charCountElement, 
        charLimitWarning, imageGeneratorBtn, imageGeneratorBtnSmall, imageGeneratorModal, 
        imageGeneratorForm, imagePrompt, imagePreviewContainer, imageLoading, imageResult, 
        generatedImage, imageRegenerateBtn, imageSendBtn, imageDownloadBtn, imageGeneratorClose,
        imageGeneratorCancel, imageStyleSelect, imageQualitySelect;

    // BOUTONS
    let startChatBtn, backBtn, themeBtn, settingsBtn, downloadHeaderBtn, downloadMainBtn, 
        helloBtn, conversationsBtn, panelClose, settingsPanelClose, panelThemeBtn, panelNewChatBtn;
    
    // BOUTONS DES PARAMÈTRES
    let settingsThemeBtn, settingsAboutBtn, settingsHelpBtn, settingsPrivacyBtn, 
        settingsContactBtn, settingsWhatsappBtn;

    // MODALS
    let aboutModal, privacyModal, helpModal, contactModal, whatsappModal;
    let aboutClose, privacyClose, helpClose, contactClose, whatsappClose;
    
    // LANGUE
    let languageToggle, languageDropdown, currentFlag, languageOptions;

    // ===== MODÈLES DE DONNÉES =====
    
    class Conversation {
        constructor(id, title) {
            this.id = id;
            this.title = title;
            this.messages = [];
            this.createdAt = new Date();
            this.updatedAt = new Date();
            this.pinned = false;
            this.totalChars = 0;
        }
    }
    
    class Message {
        constructor(id, type, content, sender, timestamp) {
            this.id = id;
            this.type = type;
            this.content = content;
            this.sender = sender;
            this.timestamp = timestamp;
            this.charCount = content.length;
        }
    }

    // ===== FONCTIONS UTILITAIRES =====
    
    function generateId() {
        return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }
    
    function formatTime(date) {
        return new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    function formatDate(date) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        const dateObj = new Date(date);
        dateObj.setHours(0, 0, 0, 0);
        
        if (dateObj.getTime() === today.getTime()) {
            return currentLanguage === 'en' ? "Today" : "Aujourd'hui";
        } else if (dateObj.getTime() === yesterday.getTime()) {
            return currentLanguage === 'en' ? "Yesterday" : "Hier";
        } else {
            return dateObj.toLocaleDateString(currentLanguage === 'en' ? 'en-US' : 'fr-FR', { 
                month: 'short', 
                day: 'numeric' 
            });
        }
    }

    // ===== GESTION DES LANGUES =====
    
    function setLanguage(lang) {
        if (lang !== currentLanguage) {
            currentLanguage = lang;
            localStorage.setItem('culturelink_language', lang);
            updateLanguageUI();
            applyTranslations();
        }
    }
    
    function loadLanguage() {
        const savedLang = localStorage.getItem('culturelink_language');
        if (savedLang && (savedLang === 'en' || savedLang === 'fr')) {
            currentLanguage = savedLang;
        } else {
            // Détecter la langue du navigateur
            const browserLang = navigator.language.split('-')[0];
            currentLanguage = (browserLang === 'fr') ? 'fr' : 'en';
        }
        updateLanguageUI();
        applyTranslations();
    }
    
    function updateLanguageUI() {
        if (currentFlag) {
            currentFlag.textContent = currentLanguage === 'en' ? '🇬🇧' : '🇫🇷';
        }
        
        if (languageOptions) {
            languageOptions.forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-lang') === currentLanguage) {
                    option.classList.add('active');
                }
            });
        }
    }
    
    function applyTranslations() {
        const t = translations[currentLanguage];
        
        // Mettre à jour le titre de la page
        document.title = t.pageTitle;
        
        // Mettre à jour tous les éléments avec des IDs
        const elementsToTranslate = [
            'logo-text', 'download-text', 'hero-title', 'welcome-text', 'slogan',
            'hero-description', 'chat-instruction', 'start-chatting-text',
            'culture-title', 'culture-content', 'culture-quote',
            'nature-title', 'nature-content', 'nature-quote',
            'anime-title', 'anime-content', 'anime-quote',
            'learning-title', 'learning-content', 'learning-quote',
            'download-button-text', 'developer-note', 'copyright',
            'conversation-name-display', 'welcome-title', 'welcome-subtitle',
            'quick-action-hello', 'quick-action-culture', 'quick-action-image',
            'quick-action-ecology', 'quick-action-quiz', 'quick-action-anime',
            'quick-action-more', 'privacy-notice',
            'conversations-panel-title', 'panel-theme-text', 'panel-new-chat-text',
            'conversations-list-title', 'settings-panel-title', 'general-settings-title',
            'about-settings-title', 'privacy-settings-title', 'contact-settings-title',
            'settings-theme-text', 'settings-about-text', 'settings-help-text',
            'settings-privacy-text', 'settings-contact-text', 'settings-whatsapp-text',
            'about-modal-title', 'privacy-modal-title', 'help-modal-title',
            'contact-modal-title', 'whatsapp-modal-title', 'image-generator-modal-title'
        ];
        
        elementsToTranslate.forEach(id => {
            const element = document.getElementById(id);
            if (element && t[id]) {
                if (id === 'message-input') {
                    element.placeholder = t.messagePlaceholder;
                } else {
                    element.textContent = t[id];
                }
            }
        });
        
        // Mettre à jour les boutons d'action rapide
        const quickActionButtons = document.querySelectorAll('.quick-action-btn[data-message]');
        quickActionButtons.forEach(btn => {
            const actionText = btn.querySelector('.quick-action-text').textContent;
            const actionKey = Object.keys(t).find(key => t[key] === actionText);
            if (actionKey && actionKey.includes('quick-action')) {
                btn.querySelector('.quick-action-text').textContent = t[actionKey];
            }
        });
        
        // Mettre à jour les options de langue dans le dropdown
        if (languageOptions) {
            languageOptions.forEach(option => {
                const lang = option.getAttribute('data-lang');
                const textSpan = option.querySelector('.language-text');
                if (textSpan) {
                    textSpan.textContent = lang === 'en' ? t.english : t.french;
                }
            });
        }
    }

    // ===== INITIALISATION =====
    function initApp() {
        initializeDOMElements();
        
        if (!conversationMessages || !messageInput || !sendBtn) {
            console.error('Éléments DOM critiques manquants');
            return;
        }
        
        // Charger la langue
        loadLanguage();
        
        // Événements de navigation
        if (startChatBtn) startChatBtn.addEventListener('click', showChat);
        if (backBtn) backBtn.addEventListener('click', handleBackButton);
        
        // Événements du thème
        if (themeBtn) themeBtn.addEventListener('click', toggleTheme);
        if (panelThemeBtn) panelThemeBtn.addEventListener('click', toggleTheme);
        if (settingsThemeBtn) settingsThemeBtn.addEventListener('click', toggleTheme);
        
        // Événements du chat
        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
        if (helloBtn) helloBtn.addEventListener('click', sendHello);
        
        // Gestion améliorée du textarea
        if (messageInput) {
            messageInput.addEventListener('keydown', handleTextareaKeydown);
        }
        
        // Compteur de caractères
        if (messageInput) {
            messageInput.addEventListener('input', () => {
                if (messageInput.value.length > MESSAGE_CHAR_LIMIT) {
                    messageInput.value = messageInput.value.substring(0, MESSAGE_CHAR_LIMIT);
                }
                updateCharCount();
            });
        }
        
        // Événements des panneaux
        if (conversationsBtn) conversationsBtn.addEventListener('click', showConversationsPanel);
        if (panelClose) panelClose.addEventListener('click', hidePanels);
        if (settingsPanelClose) settingsPanelClose.addEventListener('click', hidePanels);
        if (panelNewChatBtn) panelNewChatBtn.addEventListener('click', newChat);
        if (settingsBtn) settingsBtn.addEventListener('click', showSettingsPanel);
        if (overlay) overlay.addEventListener('click', hidePanels);
        
        // Événements des paramètres
        if (settingsAboutBtn) settingsAboutBtn.addEventListener('click', () => showModal('about'));
        if (settingsHelpBtn) settingsHelpBtn.addEventListener('click', () => showModal('help'));
        if (settingsPrivacyBtn) settingsPrivacyBtn.addEventListener('click', () => showModal('privacy'));
        if (settingsContactBtn) settingsContactBtn.addEventListener('click', () => showModal('contact'));
        if (settingsWhatsappBtn) settingsWhatsappBtn.addEventListener('click', () => showModal('whatsapp'));
        
        // Événements des modals
        if (aboutClose) aboutClose.addEventListener('click', () => hideModal('about'));
        if (privacyClose) privacyClose.addEventListener('click', () => hideModal('privacy'));
        if (helpClose) helpClose.addEventListener('click', () => hideModal('help'));
        if (contactClose) contactClose.addEventListener('click', () => hideModal('contact'));
        if (whatsappClose) whatsappClose.addEventListener('click', () => hideModal('whatsapp'));
        
        // Événements des boutons de téléchargement - MODIFICATION ICI
        if (downloadHeaderBtn) downloadHeaderBtn.addEventListener('click', handleDownloadClick);
        if (downloadMainBtn) downloadMainBtn.addEventListener('click', handleDownloadClick);
        
        // Événements des boutons d'actions rapides
        setupQuickActions();
        if (moreActionsBtn) moreActionsBtn.addEventListener('click', toggleMoreActions);
        
        // Ajuster la hauteur du textarea
        if (messageInput) {
            messageInput.addEventListener('input', autoResizeTextarea);
        }
        
        // Mettre à jour l'icône du thème
        updateThemeIcon();
        
        // Initialiser l'affichage des boutons d'actions rapides
        hideExtraQuickActions();
        
        // Événement pour le bouton de défilement vers le bas
        if (scrollToBottomBtn) {
            scrollToBottomBtn.addEventListener('click', () => {
                scrollToBottom(true);
            });
        }
        
        // Surveiller le défilement avec gestion améliorée
        if (messagesContainer) {
            messagesContainer.addEventListener('scroll', handleScrollImproved);
            messagesContainer.addEventListener('wheel', () => {
                isUserScrolling = true;
                clearTimeout(scrollTimer);
                scrollTimer = setTimeout(() => {
                    isUserScrolling = false;
                }, 1500);
            });
            
            messagesContainer.addEventListener('touchstart', () => {
                isUserScrolling = true;
            });
            
            messagesContainer.addEventListener('touchend', () => {
                setTimeout(() => {
                    isUserScrolling = false;
                }, 1500);
            });
        }
        
        // Initialiser le compteur de caractères
        updateCharCount();
        
        // Charger les conversations sauvegardées
        loadSavedConversations();
        
        // Charger le thème sauvegardé
        loadTheme();
        
        // Initialiser le générateur d'images
        initializeImageGenerator();
        
        // Initialiser la gestion de la langue
        initializeLanguage();
        
        // Focus automatique sur le champ de saisie
        setTimeout(() => {
            if (messageInput) messageInput.focus();
        }, 500);
    }

    function initializeDOMElements() {
        homeInterface = document.getElementById('home-interface');
        chatInterface = document.getElementById('chat-interface');
        messagesContainer = document.getElementById('messages-container');
        newConversation = document.getElementById('new-conversation');
        conversationMessages = document.getElementById('conversation-messages');
        messageInput = document.getElementById('message-input');
        typingIndicator = document.getElementById('typing-indicator');
        sendBtn = document.getElementById('send-btn');
        conversationsPanel = document.getElementById('conversations-panel');
        settingsPanel = document.getElementById('settings-panel');
        conversationList = document.getElementById('conversation-list');
        overlay = document.getElementById('overlay');
        quickActions = document.getElementById('quick-actions');
        moreActionsBtn = document.getElementById('more-actions-btn');
        scrollToBottomBtn = document.getElementById('scroll-to-bottom');
        charCountElement = document.getElementById('char-count');
        charLimitWarning = document.getElementById('char-limit-warning');
        
        // Boutons générateur d'images
        imageGeneratorBtn = document.getElementById('image-generator-btn');
        imageGeneratorBtnSmall = document.getElementById('image-generator-btn-small');
        imageGeneratorModal = document.getElementById('image-generator-modal');
        imageGeneratorForm = document.getElementById('image-generator-form');
        imagePrompt = document.getElementById('image-prompt');
        imagePreviewContainer = document.getElementById('image-preview-container');
        imageLoading = document.getElementById('image-loading');
        imageResult = document.getElementById('image-result');
        generatedImage = document.getElementById('generated-image');
        imageRegenerateBtn = document.getElementById('image-regenerate-btn');
        imageSendBtn = document.getElementById('image-send-btn');
        imageDownloadBtn = document.getElementById('image-download-btn');
        imageGeneratorClose = document.getElementById('image-generator-close');
        imageGeneratorCancel = document.getElementById('image-generator-cancel');
        imageStyleSelect = document.getElementById('image-style');
        imageQualitySelect = document.getElementById('image-quality');
        
        // BOUTONS
        startChatBtn = document.getElementById('start-chat-btn');
        backBtn = document.getElementById('back-btn');
        themeBtn = document.getElementById('theme-btn');
        settingsBtn = document.getElementById('settings-btn');
        downloadHeaderBtn = document.getElementById('download-header-btn');
        downloadMainBtn = document.getElementById('download-main-btn');
        helloBtn = document.getElementById('hello-btn');
        conversationsBtn = document.getElementById('conversations-btn');
        panelClose = document.getElementById('panel-close');
        settingsPanelClose = document.getElementById('settings-panel-close');
        panelThemeBtn = document.getElementById('panel-theme-btn');
        panelNewChatBtn = document.getElementById('panel-new-chat-btn');
        
        // BOUTONS DES PARAMÈTRES
        settingsThemeBtn = document.getElementById('settings-theme-btn');
        settingsAboutBtn = document.getElementById('settings-about-btn');
        settingsHelpBtn = document.getElementById('settings-help-btn');
        settingsPrivacyBtn = document.getElementById('settings-privacy-btn');
        settingsContactBtn = document.getElementById('settings-contact-btn');
        settingsWhatsappBtn = document.getElementById('settings-whatsapp-btn');

        // MODALS
        aboutModal = document.getElementById('about-modal');
        privacyModal = document.getElementById('privacy-modal');
        helpModal = document.getElementById('help-modal');
        contactModal = document.getElementById('contact-modal');
        whatsappModal = document.getElementById('whatsapp-modal');
        
        aboutClose = document.getElementById('about-close');
        privacyClose = document.getElementById('privacy-close');
        helpClose = document.getElementById('help-close');
        contactClose = document.getElementById('contact-close');
        whatsappClose = document.getElementById('whatsapp-close');
        
        // LANGUE
        languageToggle = document.getElementById('language-toggle');
        languageDropdown = document.getElementById('language-dropdown');
        currentFlag = document.getElementById('current-flag');
        languageOptions = document.querySelectorAll('.language-option');
    }

    function initializeLanguage() {
        if (languageToggle) {
            languageToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                if (languageDropdown) {
                    languageDropdown.classList.toggle('active');
                }
            });
        }
        
        if (languageOptions) {
            languageOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const lang = option.getAttribute('data-lang');
                    setLanguage(lang);
                    if (languageDropdown) {
                        languageDropdown.classList.remove('active');
                    }
                });
            });
        }
        
        // Fermer le dropdown si on clique en dehors
        document.addEventListener('click', (e) => {
            if (languageDropdown && !languageToggle.contains(e.target) && !languageDropdown.contains(e.target)) {
                languageDropdown.classList.remove('active');
            }
        });
    }

    function initializeImageGenerator() {
        if (imageGeneratorBtn) {
            imageGeneratorBtn.addEventListener('click', () => showImageGenerator());
        }
        if (imageGeneratorBtnSmall) {
            imageGeneratorBtnSmall.addEventListener('click', () => showImageGenerator());
        }
        
        if (imageGeneratorClose) {
            imageGeneratorClose.addEventListener('click', () => hideImageGenerator());
        }
        if (imageGeneratorCancel) {
            imageGeneratorCancel.addEventListener('click', () => hideImageGenerator());
        }
        
        if (imageGeneratorForm) {
            imageGeneratorForm.addEventListener('submit', (e) => {
                e.preventDefault();
                generateImage();
            });
        }
        
        const exampleButtons = document.querySelectorAll('.image-example-btn');
        exampleButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const prompt = btn.getAttribute('data-prompt');
                if (imagePrompt) {
                    imagePrompt.value = prompt;
                }
            });
        });
        
        if (imageRegenerateBtn) {
            imageRegenerateBtn.addEventListener('click', () => generateImage());
        }
        if (imageSendBtn) {
            imageSendBtn.addEventListener('click', () => sendGeneratedImageToChat());
        }
        if (imageDownloadBtn) {
            imageDownloadBtn.addEventListener('click', () => downloadGeneratedImage());
        }
    }

    // ===== NOUVELLES FONCTIONS POUR LES AMÉLIORATIONS =====
    
    function handleBackButton() {
        // Si le champ de saisie a le focus, on le perd
        if (document.activeElement === messageInput) {
            messageInput.blur();
        } else {
            // Sinon, on retourne à l'accueil
            showHome();
        }
    }
    
    function handleTextareaKeydown(e) {
        // Gestion améliorée du textarea
        if (e.key === 'Enter') {
            if (e.shiftKey) {
                // Shift+Enter: retour à la ligne
                return;
            } else if (e.ctrlKey || e.metaKey) {
                // Ctrl/Cmd+Enter: envoi du message
                e.preventDefault();
                sendMessage();
            } else {
                // Enter seul: envoi du message
                e.preventDefault();
                sendMessage();
            }
        }
    }
    
    function handleDownloadClick() {
        // Ouvrir le lien directement sans afficher de modal
        window.open('https://apk.linky.com', '_blank');
    }

    // ===== GESTION DU GÉNÉRATEUR D'IMAGES =====
    
    function showImageGenerator() {
        if (imageGeneratorModal) {
            imageGeneratorModal.classList.add('active');
            isModalOpen = true;
            document.body.classList.add('no-scroll');
            
            if (imagePrompt) imagePrompt.value = '';
            if (imageStyleSelect) imageStyleSelect.value = 'realistic';
            if (imageQualitySelect) imageQualitySelect.value = 'standard';
            
            if (imagePreviewContainer) imagePreviewContainer.style.display = 'none';
            if (imageResult) imageResult.style.display = 'none';
            if (imageLoading) imageLoading.style.display = 'none';
        }
    }
    
    function hideImageGenerator() {
        if (imageGeneratorModal) {
            imageGeneratorModal.classList.remove('active');
            isModalOpen = false;
            document.body.classList.remove('no-scroll');
        }
    }
    
    async function generateImage() {
        if (!imagePrompt || !imagePrompt.value.trim()) {
            alert(currentLanguage === 'en' ? 'Please describe the image you want to generate' : 'Veuillez décrire l\'image que vous voulez générer');
            return;
        }
        
        if (isImageGenerationInProgress) return;
        
        isImageGenerationInProgress = true;
        
        if (imagePreviewContainer) {
            imagePreviewContainer.style.display = 'block';
            if (imageLoading) imageLoading.style.display = 'flex';
            if (imageResult) imageResult.style.display = 'none';
        }
        
        const prompt = imagePrompt.value.trim();
        const style = imageStyleSelect ? imageStyleSelect.value : 'realistic';
        const quality = imageQualitySelect ? imageQualitySelect.value : 'standard';
        
        try {
            let fullPrompt = prompt;
            if (style !== 'realistic') {
                fullPrompt += `, ${style} style`;
            }
            
            if (quality === 'high') {
                fullPrompt += ', high quality, detailed';
            } else if (quality === 'ultra') {
                fullPrompt += ', ultra high quality, extremely detailed, 8k';
            }
            
            const encodedPrompt = encodeURIComponent(fullPrompt);
            const apiUrl = `${IMAGE_API_URL}?prompt=${encodedPrompt}&apikey=${API_KEY}`;
            
            console.log('Génération d\'image avec l\'URL:', apiUrl);
            
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error(`HTTP error: ${response.status}`);
            }
            
            let imageUrl;
            try {
                const data = await response.json();
                if (data.image || data.url) {
                    imageUrl = data.image || data.url;
                } else if (data.data && data.data.image) {
                    imageUrl = data.data.image;
                } else {
                    imageUrl = response.url;
                }
            } catch (jsonError) {
                console.log('Réponse non-JSON, utilisation de l\'URL directe');
                imageUrl = response.url;
            }
            
            if (generatedImage) {
                generatedImage.src = imageUrl;
                generatedImage.alt = prompt;
                
                await new Promise((resolve, reject) => {
                    generatedImage.onload = resolve;
                    generatedImage.onerror = reject;
                    setTimeout(resolve, 3000);
                });
                
                if (imageLoading) imageLoading.style.display = 'none';
                if (imageResult) imageResult.style.display = 'block';
                
                generatedImage.dataset.downloadUrl = imageUrl;
            }
            
        } catch (error) {
            console.error('Erreur lors de la génération d\'image:', error);
            alert(currentLanguage === 'en' ? 'An error occurred while generating the image. Please try again.' : 'Une erreur est survenue lors de la génération de l\'image. Veuillez réessayer.');
            
            if (imageLoading) {
                imageLoading.innerHTML = `
                    <div style="text-align: center; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>${currentLanguage === 'en' ? 'Failed to generate image. Please try again.' : 'Échec de la génération de l\'image. Veuillez réessayer.'}</p>
                    </div>
                `;
            }
        } finally {
            isImageGenerationInProgress = false;
        }
    }
    
    function sendGeneratedImageToChat() {
        if (!generatedImage || !generatedImage.src) return;
        
        const imageUrl = generatedImage.src;
        const prompt = imagePrompt ? imagePrompt.value.trim() : '';
        
        const imageMessage = new Message(
            generateId(),
            'image',
            imageUrl,
            'user',
            new Date()
        );
        
        imageMessage.description = prompt;
        
        addMessageToConversation(imageMessage);
        addMessageToDOM(imageMessage);
        
        hideImageGenerator();
        
        scrollToBottom(true);
        
        setTimeout(() => {
            const botResponse = new Message(
                generateId(),
                'text',
                currentLanguage === 'en' 
                    ? `🎨 **Image generated successfully!**\n\nI have received your image request: *"${prompt}"*\n\n**What would you like to do now?**\n• Describe this image in detail 🖼️\n• Generate another different image 🔄\n• Discuss its cultural context 🌍\n\n*Tell me what interests you!* 🐇`
                    : `🎨 **Image générée avec succès !**\n\nJ'ai bien reçu votre demande d'image : *"${prompt}"*\n\n**Que voulez-vous faire maintenant ?**\n• Décrire cette image en détail 🖼️\n• Générer une autre image différente 🔄\n• Discuter de son contexte culturel 🌍\n\n*Dites-moi ce qui vous intéresse !* 🐇`,
                'bot',
                new Date()
            );
            
            addMessageWithStreamingEffect(botResponse);
        }, 1000);
    }
    
    function downloadGeneratedImage() {
        if (!generatedImage || !generatedImage.src) return;
        
        const imageUrl = generatedImage.src;
        const prompt = imagePrompt ? imagePrompt.value.trim() : 'generated-image';
        
        const link = document.createElement('a');
        link.href = imageUrl;
        link.download = `culturelink-${prompt.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${Date.now()}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ===== NOUVELLE API AVEC RÉPONSE PROGRESSIVE =====
    
    async function callLinkyAPI(userMessage) {
        try {
            const fullPrompt = `${LINKY_PROMPT}\n\nMessage de l'utilisateur: ${userMessage}`;
            const url = `${TEXT_API_URL}?apikey=${API_KEY}&query=${encodeURIComponent(fullPrompt)}&uid=${currentUserId}&model=${MODEL}`;
            
            console.log('Appel API Linky vers:', url);
            
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.status === true && data.response) {
                return data.response;
            } else if (data.reply) {
                return data.reply;
            } else if (data.message) {
                return data.message;
            } else {
                throw new Error('Format de réponse invalide');
            }
            
        } catch (error) {
            console.error('Erreur API Linky:', error);
            return getFallbackResponse(userMessage, error);
        }
    }
    
    function formatAPIResponse(text) {
        if (!text) return '';
        
        let formatted = text;
        
        formatted = formatted.replace(/^##\s+(.+)$/gm, '<h3>$1</h3>');
        formatted = formatted.replace(/^###\s+(.+)$/gm, '<h4>$1</h4>');
        
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
        formatted = formatted.replace(/__(.*?)__/g, '<u>$1</u>');
        
        formatted = formatted.replace(/^\s*[-*•]\s+(.+)$/gm, '<li>$1</li>');
        formatted = formatted.replace(/^\s*\d+\.\s+(.+)$/gm, '<li>$1</li>');
        
        formatted = formatted.replace(/```([\s\S]*?)```/g, '<code>$1</code>');
        formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');
        
        formatted = formatted.replace(/^>\s+(.+)$/gm, '<blockquote>$1</blockquote>');
        
        formatted = formatted.replace(/\n\n/g, '</p><p>');
        formatted = formatted.replace(/\n(?!\n)/g, '<br>');
        
        formatted = formatted.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        formatted = formatted.replace(/&lt;(strong|em|u|h3|h4|li|code|blockquote|p|br|ul|ol)&gt;/g, '<$1>');
        formatted = formatted.replace(/&lt;\/(strong|em|u|h3|h4|li|code|blockquote|p|br|ul|ol)&gt;/g, '</$1>');
        
        let lines = formatted.split('\n');
        let inList = false;
        let listType = '';
        let result = [];
        
        for (let line of lines) {
            if (line.includes('<li>')) {
                if (!inList) {
                    inList = true;
                    listType = line.match(/^\d+\./) ? 'ol' : 'ul';
                    result.push(`<${listType} class="formatted-list">`);
                }
                result.push(line);
            } else {
                if (inList) {
                    result.push(`</${listType}>`);
                    inList = false;
                    listType = '';
                }
                result.push(line);
            }
        }
        
        if (inList) {
            result.push(`</${listType}>`);
        }
        
        formatted = result.join('\n');
        
        return `<div class="formatted-response">${formatted}</div>`;
    }
    
    function getFallbackResponse(userMessage, error) {
        const lowerUserMessage = userMessage.toLowerCase();
        const errorMessage = error.message || '';
        
        if (errorMessage.includes('Failed to fetch') || errorMessage.includes('Network')) {
            return currentLanguage === 'en' 
                ? "**🌐 Connection Problem**\n\nI cannot connect to the server. Please check your internet connection and try again.\n\n*Meanwhile, I can tell you about:*\n• **African culture** 🇧🇫\n• **Ecology** 🌱\n• **Animes** 🎬\n• **Traditional cuisine** 🍲\n\nWhat topic interests you?"
                : "**🌐 Problème de connexion**\n\nJe ne peux pas me connecter au serveur. Veuillez vérifier votre connexion internet et réessayer.\n\n*En attendant, je peux vous parler de :*\n• **Culture africaine** 🇧🇫\n• **Écologie** 🌱\n• **Animes** 🎬\n• **Cuisine traditionnelle** 🍲\n\nQuel sujet vous intéresse ?";
        }
        
        if (lowerUserMessage.includes('bonjour') || lowerUserMessage.includes('hello') || lowerUserMessage.includes('salut')) {
            return currentLanguage === 'en'
                ? "**Hi! 😎**\n\nI'm Linky 🐇, your cultural buddy from Burkina 🇧🇫 in full revolutionary effervescence!\n\n*I'm passionate about:*\n🌍 **Culture & History**\n🌱 **Ecology & Environment**\n🎬 **Animes & Entertainment**\n🍲 **Cuisine & Traditions**\n🎓 **Learning & Pedagogy**\n\n**What brings you on this discovery journey today?** 🐇✨"
                : "**Salut ! 😎**\n\nJe suis Linky 🐇, ton pote culturel du Burkina 🇧🇫 en pleine effervescence révolutionnaire !\n\n*Je suis passionné par :*\n🌍 **Culture & Histoire**\n🌱 **Écologie & Environnement**\n🎬 **Animes & Divertissement**\n🍲 **Cuisine & Traditions**\n🎓 **Apprentissage & Pédagogie**\n\n**Qu'est-ce qui t'amène dans ce voyage de découvertes aujourd'hui ?** 🐇✨";
        }
        
        if (lowerUserMessage.includes('culture') || lowerUserMessage.includes('afric')) {
            return currentLanguage === 'en'
                ? "**🇧🇫 African Culture - Our Wealth!**\n\nAfrican culture is *incredibly diverse* and **profoundly rich**!\n\n*Some gems:*\n\n**🏛️ Ancestral Civilizations**\n• **Mossi Empire** - Guardians of Burkinabè traditions\n• **Ashanti Kingdom** - Gold and social organization\n• **Yoruba Civilization** - Art and spirituality\n\n**🎨 Arts & Traditions**\n• **Ritual masks**\n• **Bogolan textiles**\n• **Percussive music**\n\n**💫 African Values**\n• *Ubuntu* - \"I am because we are\"\n• **Community solidarity**\n• Respect for **elders and ancestors**\n\n**What aspect would you like to focus on?** 🐇"
                : "**🇧🇫 Culture Africaine - Notre Richesse !**\n\nLa culture africaine est *incroyablement diverse* et **profondément riche** !\n\n*Quelques joyaux :*\n\n**🏛️ Civilisations Ancestrales**\n• **Empire Mossi** - Gardiens des traditions burkinabè\n• **Royaume Ashanti** - Or et organisation sociale\n• **Civilisation Yoruba** - Art et spiritualité\n\n**🎨 Arts & Traditions**\n• **Masques rituels**\n• **Textiles bogolan**\n• **Musique percussive**\n\n**💫 Valeurs Africaines**\n• *Ubuntu* - \"Je suis parce que nous sommes\"\n• **Solidarité communautaire**\n• Respect des **aînés et ancêtres**\n\n**Sur quel aspect veux-tu qu'on se concentre ?** 🐇";
        }
        
        if (lowerUserMessage.includes('écologie') || lowerUserMessage.includes('nature') || lowerUserMessage.includes('environnement') || lowerUserMessage.includes('ecology')) {
            return currentLanguage === 'en'
                ? "**🌱 African Ecology - Wisdom & Solutions**\n\nAfrica possesses *millennial ecological wisdom*!\n\n**🌍 Unique Biodiversity**\n• **Sacred forests** - Biodiversity sanctuaries\n• **Savannas** - Complex ecosystems\n• **Deserts** - Extraordinary adaptations\n\n**💡 Traditional Solutions**\n• **Sustainable agriculture**\n• **Community resource management**\n• **Plant-based medicine**\n\n**🚀 Challenges & Opportunities**\n• **Climate change**\n• **Innovative conservation**\n• **Green economy**\n\n**What aspect of ecology interests you?** 🌿"
                : "**🌱 Écologie Africaine - Sagesse & Solutions**\n\nL'Afrique possède une *sagesse écologique millénaire* !\n\n**🌍 Biodiversité Unique**\n• **Forêts sacrées** - Sanctuaires de biodiversité\n• **Savanes** - Écosystèmes complexes\n• **Déserts** - Adaptations extraordinaires\n\n**💡 Solutions Traditionnelles**\n• **Agriculture durable**\n• **Gestion communautaire des ressources**\n• **Médecine par les plantes**\n\n**🚀 Défis & Opportunités**\n• **Changement climatique**\n• **Conservation innovante**\n• **Économie verte**\n\n**Quel aspect de l'écologie t'intéresse ?** 🌿";
        }
        
        if (lowerUserMessage.includes('anime') || lowerUserMessage.includes('manga')) {
            return currentLanguage === 'en'
                ? "**🎬 Animes - Windows to the Imaginary**\n\nI *love* animes! They transport us to **incredible worlds**.\n\n**🔥 My Favorites**\n1. **Attack on Titan** - *Deep themes of freedom and survival*\n2. **Demon Slayer** - **Breathtaking animation**\n3. **One Piece** - *Adventure and friendship without limits*\n\n**🇯🇵 Japanese Culture**\n• **Unique aesthetics**\n• **Values of perseverance**\n• **Narrative richness**\n\n**Are you looking for a recommendation or a specific analysis?** 🎭"
                : "**🎬 Animes - Fenêtres sur l'Imaginaire**\n\nJ'*adore* les animes ! Ils nous transportent dans des **mondes incroyables**.\n\n**🔥 Mes Coups de Cœur**\n1. **Attack on Titan** - *Thèmes profonds de liberté et survie*\n2. **Demon Slayer** - **Animation époustouflante**\n3. **One Piece** - *Aventure et amitié sans limites*\n\n**🇯🇵 Culture Japonaise**\n• **Esthétique unique**\n• **Valeurs de persévérance**\n• **Richesse narrative**\n\n**Tu cherches une recommandation ou une analyse spécifique ?** 🎭";
        }
        
        if (lowerUserMessage.includes('cuisine') || lowerUserMessage.includes('recette') || lowerUserMessage.includes('manger') || lowerUserMessage.includes('food')) {
            return currentLanguage === 'en'
                ? "**🍲 African Cuisine - Flavors & Traditions**\n\nAfrican cuisine is a **feast for the senses**!\n\n**🇧🇫 Burkinabè Specialties**\n• **Riz gras** - *Rice with vegetables and meat*\n• **Tô** - **Millet or corn ball**\n• **Poulet bicyclette** - *Grilled farm chicken*\n\n**🌍 Continental Diversity**\n• **Couscous** - Maghreb\n• **Jollof rice** - West Africa\n• **Injera** - Horn of Africa\n\n**Do you want a specific recipe or info about a dish?** 👨‍🍳"
                : "**🍲 Cuisine Africaine - Saveurs & Traditions**\n\nLa cuisine africaine est une **fête des sens** !\n\n**🇧🇫 Spécialités Burkinabè**\n• **Riz gras** - *Riz aux légumes et viande*\n• **Tô** - **Boule de mil ou maïs**\n• **Poulet bicyclette** - *Poulet fermier grillé*\n\n**🌍 Diversité Continentale**\n• **Couscous** - Maghreb\n• **Jollof rice** - Afrique de l'Ouest\n• **Injera** - Corne de l'Afrique\n\n**Tu veux une recette spécifique ou des infos sur un plat ?** 👨‍🍳";
        }
        
        return currentLanguage === 'en'
            ? "**🐇 Linky at your service!**\n\nHi! I'm your cultural companion from Burkina Faso 🇧🇫, in the midst of a revolution of ideas and creativity!\n\n*I can help you with:*\n\n**📚 Culture & History**\n• African civilizations\n• Traditions and arts\n• World heritage\n\n**🌱 Ecology & Environment**\n• Biodiversity\n• Sustainable solutions\n• Traditional knowledge\n\n**🎬 Entertainment & Animes**\n• Recommendations\n• Analyses\n• Pop culture\n\n**🍲 Cuisine & Traditions**\n• Authentic recipes\n• Culinary stories\n• Traditional techniques\n\n**🎓 Pedagogy & Learning**\n• Clear explanations\n• Educational quizzes\n• Homework help\n\n**Where would you like to start our exploration?** 🌟"
            : "**🐇 Linky à ton service !**\n\nSalut ! Je suis ton compagnon culturel du Burkina Faso 🇧🇫, en pleine révolution d'idées et de créativité !\n\n*Je peux t'aider avec :*\n\n**📚 Culture & Histoire**\n• Civilisations africaines\n• Traditions et arts\n• Patrimoine mondial\n\n**🌱 Écologie & Environnement**\n• Biodiversité\n• Solutions durables\n• Savoirs traditionnels\n\n**🎬 Divertissement & Animes**\n• Recommandations\n• Analyses\n• Culture pop\n\n**🍲 Cuisine & Traditions**\n• Recettes authentiques\n• Histoires culinaires\n• Techniques traditionnelles\n\n**🎓 Pédagogie & Apprentissage**\n• Explications claires\n• Quiz éducatifs\n• Aide aux devoirs\n\n**Par où veux-tu commencer notre exploration ?** 🌟";
    }

    // ===== GESTION DES MESSAGES AVEC EFFET PROGRESSIF =====
    
    function addMessageToDOM(message, animate = true) {
        if (!conversationMessages) return null;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.sender}-message ${message.type}-message`;
        messageDiv.id = message.id;
        
        if (animate) {
            messageDiv.style.animation = 'messageSlideIn 0.3s ease';
        }
        
        const avatar = message.sender === 'user' ? 'U' : '🐇';
        const time = formatTime(message.timestamp);
        
        let content = '';
        if (message.type === 'image') {
            content = `
                <div class="generated-image">
                    <img src="${message.content}" alt="${message.description || 'Generated image'}" style="max-width: 100%; border-radius: 12px;">
                    <div class="image-actions">
                        <button class="image-action-btn delete-btn" onclick="deleteMessage('${message.id}')">
                            <i class="fas fa-trash"></i> ${currentLanguage === 'en' ? 'Delete' : 'Supprimer'}
                        </button>
                    </div>
                </div>
            `;
        } else {
            content = message.content;
        }
        
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-avatar">${avatar}</div>
                <div class="message-text">
                    ${content}
                    <div class="message-time">${time}</div>
                </div>
            </div>
        `;
        
        conversationMessages.appendChild(messageDiv);
        
        setTimeout(() => {
            messageDiv.classList.add('highlighted');
            setTimeout(() => {
                messageDiv.classList.remove('highlighted');
            }, 2000);
        }, 100);
        
        return messageDiv;
    }
    
    function addMessageWithStreamingEffect(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message bot-message text-message';
        messageDiv.id = message.id;
        
        const time = formatTime(message.timestamp);
        
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-avatar thinking">🐇</div>
                <div class="message-text">
                    <span id="${message.id}-text"></span>
                    <div class="message-time">${time}</div>
                </div>
            </div>
        `;
        
        if (conversationMessages) {
            conversationMessages.appendChild(messageDiv);
        }
        
        currentStreamingMessage = message;
        streamingChars = [];
        
        streamMessageText(message.content, message.id);
        
        return messageDiv;
    }
    
    function streamMessageText(text, messageId) {
        const textElement = document.getElementById(`${messageId}-text`);
        if (!textElement) return;
        
        const cleanText = text.replace(/<[^>]*>/g, '');
        const chars = cleanText.split('');
        
        let index = 0;
        let formattedBuffer = '';
        let inTag = false;
        let currentTag = '';
        
        function streamNextChar() {
            if (index >= chars.length) {
                finishStreaming(text, messageId);
                return;
            }
            
            const char = chars[index];
            
            if (char === '<') {
                inTag = true;
                currentTag = '<';
            } else if (char === '>' && inTag) {
                currentTag += '>';
                inTag = false;
                formattedBuffer += currentTag;
                currentTag = '';
            } else if (inTag) {
                currentTag += char;
            } else {
                formattedBuffer += char;
            }
            
            textElement.innerHTML = formatAPIResponse(formattedBuffer) + '<span class="typing-cursor"></span>';
            
            index++;
            
            const delay = Math.random() * 30 + 20;
            
            smartScrollDuringStreaming();
            
            setTimeout(streamNextChar, delay);
        }
        
        streamNextChar();
    }
    
    function finishStreaming(fullText, messageId) {
        const textElement = document.getElementById(`${messageId}-text`);
        if (textElement) {
            textElement.innerHTML = formatAPIResponse(fullText);
        }
        
        if (currentStreamingMessage) {
            currentStreamingMessage.content = fullText;
            addMessageToConversation(currentStreamingMessage);
        }
        
        currentStreamingMessage = null;
        streamingChars = [];
        
        finishTyping();
        
        scrollToBottom(true);
    }

    // ===== DÉFILEMENT AUTOMATIQUE AMÉLIORÉ =====
    
    function handleScrollImproved() {
        if (!messagesContainer || !scrollToBottomBtn) return;
        
        const scrollPosition = messagesContainer.scrollTop;
        const containerHeight = messagesContainer.clientHeight;
        const contentHeight = messagesContainer.scrollHeight;
        
        const distanceFromBottom = contentHeight - scrollPosition - containerHeight;
        const isNearBottom = distanceFromBottom < 100;
        
        if (isNearBottom) {
            autoScrollEnabled = true;
            scrollToBottomBtn.classList.remove('visible');
            isUserScrolling = false;
        } else {
            autoScrollEnabled = false;
            scrollToBottomBtn.classList.add('visible');
            isUserScrolling = true;
            
            clearTimeout(scrollTimer);
            scrollTimer = setTimeout(() => {
                isUserScrolling = false;
            }, 2000);
        }
    }
    
    function smartScrollDuringStreaming() {
        if (!messagesContainer || isUserScrolling) return;
        
        const scrollPosition = messagesContainer.scrollTop;
        const containerHeight = messagesContainer.clientHeight;
        const contentHeight = messagesContainer.scrollHeight;
        
        const distanceFromBottom = contentHeight - scrollPosition - containerHeight;
        const isNearBottom = distanceFromBottom < 300;
        
        if (isNearBottom) {
            requestAnimationFrame(() => {
                messagesContainer.scrollTo({
                    top: contentHeight,
                    behavior: 'smooth'
                });
            });
        }
    }
    
    function scrollToBottom(force = false) {
        if (!messagesContainer || isModalOpen) return;
        
        if (force || (autoScrollEnabled && !isUserScrolling)) {
            requestAnimationFrame(() => {
                const contentHeight = messagesContainer.scrollHeight;
                const containerHeight = messagesContainer.clientHeight;
                
                messagesContainer.scrollTo({
                    top: contentHeight - containerHeight,
                    behavior: force ? 'smooth' : 'instant'
                });
                
                if (force && scrollToBottomBtn) {
                    scrollToBottomBtn.classList.remove('visible');
                }
            });
        }
    }

    // ===== FONCTION PRINCIPALE D'ENVOI =====
    
    async function sendMessage() {
        if (!messageInput) return;
        
        const text = messageInput.value.trim();
        if (!text || isApiCallInProgress) return;

        if (text.length > MESSAGE_CHAR_LIMIT) {
            showCharLimitWarning('message');
            return;
        }

        if (!currentConversationId || conversations.find(c => c.id === currentConversationId)?.messages.length === 0) {
            if (newConversation) newConversation.style.display = 'none';
            if (conversationMessages) conversationMessages.style.display = 'block';
        }

        if (!currentConversationId) {
            createNewConversation(text);
        }

        const userMessage = new Message(
            generateId(),
            'text',
            text,
            'user',
            new Date()
        );
        
        addMessageToConversation(userMessage);
        addMessageToDOM(userMessage);
        
        messageInput.value = '';
        updateCharCount();
        autoResizeTextarea();
        
        if (sendBtn) {
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
        }
        
        scrollToBottom(true);
        
        await getBotResponseWithStreaming(text);
    }
    
    async function getBotResponseWithStreaming(userMessage) {
        isTyping = true;
        isApiCallInProgress = true;
        
        try {
            const apiResponse = await callLinkyAPI(userMessage);
            
            const botMessage = new Message(
                generateId(),
                'text',
                apiResponse,
                'bot',
                new Date()
            );
            
            addMessageWithStreamingEffect(botMessage);
            
        } catch (error) {
            console.error('Erreur lors de la réponse:', error);
            
            const errorMessage = new Message(
                generateId(),
                'text',
                currentLanguage === 'en'
                    ? "**⚠️ Oops! Technical issue**\n\nI'm encountering a small issue processing your request. It happens even to the best digital griots!\n\n*In the meantime:*\n• **Reload the page**\n• **Check your connection**\n• **Try again in 2 minutes**\n\n*Otherwise, let's talk about:*\n🌍 **African culture**\n🌱 **Ecology**\n🎬 **Your favorite animes**\n\n**What do you say?** 🐇"
                    : "**⚠️ Oups ! Problème technique**\n\nJe rencontre un petit souci pour traiter ta demande. Ça arrive même aux meilleurs griots digitaux !\n\n*En attendant :*\n• **Recharge la page**\n• **Vérifie ta connexion**\n• **Réessaye dans 2 minutes**\n\n*Sinon, parlons de :*\n🌍 **Culture africaine**\n🌱 **Écologie**\n🎬 **Tes animes préférés**\n\n**Ça te dit ?** 🐇",
                'bot',
                new Date()
            );
            
            addMessageWithStreamingEffect(errorMessage);
        }
    }
    
    function finishTyping() {
        isTyping = false;
        isPaused = false;
        isApiCallInProgress = false;
        
        if (sendBtn) {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
        }
        
        if (typingIndicator) {
            typingIndicator.style.display = 'none';
        }
    }

    // ===== GESTION DES CONVERSATIONS =====
    
    function createNewConversation(firstMessage = null) {
        const id = generateId();
        
        let title;
        if (firstMessage) {
            title = (firstMessage.length > 30 ? firstMessage.substring(0, 30) + '...' : firstMessage);
            
            let counter = 1;
            let baseTitle = title;
            while (conversations.some(c => c.title === title)) {
                title = `${baseTitle} (${counter})`;
                counter++;
            }
        } else {
            title = currentLanguage === 'en' ? "New conversation" : "Nouvelle conversation";
        }
        
        const conversation = new Conversation(id, title);
        conversations.unshift(conversation);
        currentConversationId = id;
        
        saveConversations();
        updateConversationList();
        updateConversationName();
        
        return conversation;
    }
    
    function addMessageToConversation(message, conversationId = null) {
        const targetConversationId = conversationId || currentConversationId;
        const conversation = conversations.find(c => c.id === targetConversationId);
        
        if (!conversation) return null;
        
        if (conversation.totalChars + message.charCount > CONVERSATION_CHAR_LIMIT) {
            showCharLimitWarning('conversation');
            return null;
        }
        
        conversation.messages.push(message);
        conversation.updatedAt = new Date();
        conversation.totalChars += message.charCount;
        
        if (conversation.messages.length === 1 && message.sender === 'user') {
            conversation.title = (message.content.length > 30 ? 
                message.content.substring(0, 30) + '...' : 
                message.content);
        }
        
        saveConversations();
        updateConversationList();
        
        return conversation;
    }
    
    function saveConversations() {
        try {
            localStorage.setItem('culturelink_conversations', JSON.stringify(conversations));
        } catch (error) {
            console.error('Erreur sauvegarde conversations:', error);
            if (error.name === 'QuotaExceededError') {
                alert(currentLanguage === 'en' 
                    ? "Insufficient storage space. Old conversations will be deleted."
                    : "Espace de stockage insuffisant. Les anciennes conversations seront supprimées.");
                conversations = conversations.slice(0, 5);
                saveConversations();
            }
        }
    }
    
    function loadSavedConversations() {
        try {
            const saved = localStorage.getItem('culturelink_conversations');
            if (saved) {
                const parsed = JSON.parse(saved);
                conversations = parsed.map(conv => {
                    const conversation = new Conversation(conv.id, conv.title);
                    conversation.messages = conv.messages || [];
                    conversation.createdAt = new Date(conv.createdAt);
                    conversation.updatedAt = new Date(conv.updatedAt);
                    conversation.pinned = conv.pinned || false;
                    conversation.totalChars = conv.totalChars || 0;
                    return conversation;
                });
                
                updateConversationList();
            }
        } catch (error) {
            console.error('Erreur chargement conversations:', error);
            conversations = [];
        }
    }
    
    function updateConversationList() {
        if (!conversationList) return;
        
        conversationList.innerHTML = '';
        
        const nonEmptyConversations = conversations.filter(c => c.messages.length > 0);
        
        if (nonEmptyConversations.length === 0) {
            conversationList.innerHTML = `
                <div class="empty-conversations">
                    <i class="fas fa-comments" style="font-size: 2rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                    <div style="text-align: center; opacity: 0.7; padding: 1rem;">
                        ${currentLanguage === 'en' ? 'No conversations' : 'Aucune conversation'}
                    </div>
                </div>
            `;
            return;
        }
        
        const sortedConversations = [...nonEmptyConversations].sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return new Date(b.updatedAt) - new Date(a.updatedAt);
        });
        
        sortedConversations.forEach(conversation => {
            conversationList.appendChild(createConversationItem(conversation));
        });
    }
    
    function createConversationItem(conversation) {
        const conversationItem = document.createElement('div');
        conversationItem.className = `conversation-item ${conversation.id === currentConversationId ? 'active' : ''} ${conversation.pinned ? 'pinned' : ''}`;
        
        const lastMessage = conversation.messages[conversation.messages.length - 1];
        let preview = currentLanguage === 'en' ? "New conversation" : "Nouvelle conversation";
        
        if (lastMessage) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = lastMessage.content;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            preview = textContent.length > 50 ? textContent.substring(0, 50) + '...' : textContent;
        }
        
        const timeStr = formatTime(conversation.updatedAt);
        const dateStr = formatDate(conversation.updatedAt);
        
        conversationItem.innerHTML = `
            <div class="conversation-avatar">${conversation.pinned ? '📌' : '🐇'}</div>
            <div class="conversation-info">
                <div class="conversation-title">${conversation.title}</div>
                <div class="conversation-preview">${preview}</div>
                <div class="conversation-date">${dateStr} • ${timeStr}</div>
            </div>
            <div class="conversation-actions">
                <button class="conversation-action-btn delete-btn" title="${currentLanguage === 'en' ? 'Delete' : 'Supprimer'}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        conversationItem.addEventListener('click', (e) => {
            if (!e.target.closest('.conversation-actions')) {
                loadConversation(conversation.id);
                hidePanels();
            }
        });
        
        const deleteBtn = conversationItem.querySelector('.delete-btn');
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteConversation(conversation.id);
        });
        
        return conversationItem;
    }
    
    function deleteConversation(conversationId) {
        if (confirm(currentLanguage === 'en' 
            ? 'Are you sure you want to delete this conversation? This action is irreversible.'
            : 'Êtes-vous sûr de vouloir supprimer cette conversation ? Cette action est irréversible.')) {
            const index = conversations.findIndex(c => c.id === conversationId);
            if (index !== -1) {
                conversations.splice(index, 1);
                
                if (currentConversationId === conversationId) {
                    if (conversations.length > 0) {
                        loadConversation(conversations[0].id);
                    } else {
                        currentConversationId = null;
                        clearChatInterface();
                    }
                }
                
                updateConversationList();
                saveConversations();
            }
        }
    }
    
    function loadConversation(conversationId) {
        if (isApiCallInProgress) {
            finishTyping();
        }
        
        if (currentConversationId === conversationId) return;
        
        const conversation = conversations.find(c => c.id === conversationId);
        if (!conversation) return;
        
        currentConversationId = conversationId;
        renderConversationMessages(conversation);
        
        if (newConversation) newConversation.style.display = 'none';
        if (conversationMessages) {
            conversationMessages.style.display = 'block';
            conversationMessages.scrollTop = conversationMessages.scrollHeight;
        }
        
        updateConversationName();
        scrollToBottom(true);
    }
    
    function renderConversationMessages(conversation) {
        if (!conversationMessages) return;
        
        conversationMessages.innerHTML = '';
        
        if (conversation.messages.length > 50) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'conversation-info-message';
            infoDiv.innerHTML = `<div class="info-text">${conversation.messages.length} ${currentLanguage === 'en' ? 'messages in this conversation' : 'messages dans cette conversation'}</div>`;
            conversationMessages.appendChild(infoDiv);
        }
        
        conversation.messages.forEach(message => {
            addMessageToDOM(message, false);
        });
    }

    // ===== FONCTIONS D'INTERFACE =====
    
    function showChat() {
        if (homeInterface) homeInterface.classList.remove('active');
        if (chatInterface) chatInterface.classList.add('active');
        if (newConversation) newConversation.style.display = 'flex';
        if (conversationMessages) conversationMessages.style.display = 'none';
        currentConversationId = null;
        
        setTimeout(() => {
            if (messageInput) messageInput.focus();
        }, 300);
    }

    function showHome() {
        if (chatInterface) chatInterface.classList.remove('active');
        if (homeInterface) homeInterface.classList.add('active');
    }

    function toggleTheme() {
        currentTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', currentTheme);
        localStorage.setItem('culturelink_theme', currentTheme);
        updateThemeIcon();
    }
    
    function loadTheme() {
        const savedTheme = localStorage.getItem('culturelink_theme');
        if (savedTheme) {
            currentTheme = savedTheme;
            document.body.setAttribute('data-theme', savedTheme);
        }
        updateThemeIcon();
    }

    function updateThemeIcon() {
        const themeIcons = document.querySelectorAll('#theme-btn i, #panel-theme-btn i, #settings-theme-btn i');
        themeIcons.forEach(icon => {
            if (currentTheme === 'light') {
                icon.className = 'fas fa-sun';
            } else {
                icon.className = 'fas fa-moon';
            }
        });
    }

    function showConversationsPanel() {
        if (conversationsPanel) conversationsPanel.classList.add('active');
        if (overlay) overlay.classList.add('active');
        document.body.classList.add('no-scroll');
        updateConversationList();
    }

    function showSettingsPanel() {
        if (settingsPanel) settingsPanel.classList.add('active');
        if (overlay) overlay.classList.add('active');
        document.body.classList.add('no-scroll');
    }

    function hidePanels() {
        if (conversationsPanel) conversationsPanel.classList.remove('active');
        if (settingsPanel) settingsPanel.classList.remove('active');
        if (overlay) overlay.classList.remove('active');
        document.body.classList.remove('no-scroll');
    }

    function newChat() {
        createNewConversation();
        clearChatInterface();
        hidePanels();
        if (messageInput) messageInput.focus();
    }
    
    function clearChatInterface() {
        if (conversationMessages) conversationMessages.innerHTML = '';
        if (newConversation) newConversation.style.display = 'flex';
        if (conversationMessages) conversationMessages.style.display = 'none';
        updateConversationName();
            
        if (isTyping) {
            finishTyping();
        }
        
        setTimeout(() => {
            if (messageInput) messageInput.focus();
        }, 100);
    }
    
    function updateConversationName() {
        const conversation = conversations.find(c => c.id === currentConversationId);
        const displayElement = document.getElementById('conversation-name-display');
        if (displayElement) {
            const t = translations[currentLanguage];
            displayElement.textContent = conversation ? conversation.title : t.conversationName;
        }
    }

    function sendHello() {
        if (messageInput) {
            messageInput.value = currentLanguage === 'en' ? "Hello 👋, how are you?" : "Bonjour 👋, comment ça va ?";
            sendMessage();
        }
    }

    function setupQuickActions() {
        const quickActionBtns = document.querySelectorAll('.quick-action-btn[data-message]');
        quickActionBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const message = btn.getAttribute('data-message');
                if (messageInput) {
                    messageInput.value = message;
                    messageInput.focus();
                    messageInput.select();
                }
            });
        });
    }

    function hideExtraQuickActions() {
        const hiddenActions = document.querySelectorAll('.quick-action-btn.hidden-action');
        hiddenActions.forEach(action => {
            action.style.display = 'none';
        });
        if (moreActionsBtn) {
            moreActionsBtn.style.display = 'flex';
        }
        isMoreActionsExpanded = false;
    }

    function toggleMoreActions() {
        const hiddenActions = document.querySelectorAll('.quick-action-btn.hidden-action');
        
        if (isMoreActionsExpanded) {
            hiddenActions.forEach(action => {
                action.style.display = 'none';
            });
            if (moreActionsBtn) {
                moreActionsBtn.querySelector('.quick-action-text').textContent = currentLanguage === 'en' ? "More" : "Plus";
                moreActionsBtn.querySelector('i').className = 'fas fa-chevron-down';
            }
            isMoreActionsExpanded = false;
        } else {
            hiddenActions.forEach(action => {
                action.style.display = 'flex';
            });
            if (moreActionsBtn) {
                moreActionsBtn.querySelector('.quick-action-text').textContent = currentLanguage === 'en' ? "Less" : "Moins";
                moreActionsBtn.querySelector('i').className = 'fas fa-chevron-up';
            }
            isMoreActionsExpanded = true;
        }
    }

    // ===== COMPTEUR DE CARACTÈRES =====
    
    function updateCharCount() {
        if (!charCountElement || !messageInput) return;
        
        const count = messageInput.value.length;
        const remaining = MESSAGE_CHAR_LIMIT - count;
        const countSpan = charCountElement.querySelector('span');
        
        if (!countSpan) return;
        
        if (remaining <= 0) {
            countSpan.textContent = `${count} / ${MESSAGE_CHAR_LIMIT}`;
            charCountElement.classList.add('danger');
            charCountElement.classList.remove('warning');
        } else if (remaining <= 500) {
            countSpan.textContent = `${count} / ${MESSAGE_CHAR_LIMIT}`;
            charCountElement.classList.add('warning');
            charCountElement.classList.remove('danger');
        } else {
            countSpan.textContent = `${count}`;
            charCountElement.classList.remove('warning', 'danger');
        }
        
        if (charLimitWarning) {
            if (remaining <= 0) {
                charLimitWarning.style.display = 'block';
                charLimitWarning.textContent = currentLanguage === 'en' 
                    ? `Limit exceeded (${MESSAGE_CHAR_LIMIT} characters maximum)`
                    : `Limite dépassée (${MESSAGE_CHAR_LIMIT} caractères maximum)`;
            } else {
                charLimitWarning.style.display = 'none';
            }
        }
    }
    
    function showCharLimitWarning(type) {
        if (type === 'message') {
            alert(currentLanguage === 'en'
                ? `Message too long! The limit is ${MESSAGE_CHAR_LIMIT} characters. Please shorten your message.`
                : `Message trop long ! La limite est de ${MESSAGE_CHAR_LIMIT} caractères. Veuillez raccourcir votre message.`);
        } else if (type === 'conversation') {
            alert(currentLanguage === 'en'
                ? `Conversation limit reached (${CONVERSATION_CHAR_LIMIT} characters). Please start a new conversation.`
                : `Limite de conversation atteinte (${CONVERSATION_CHAR_LIMIT} caractères). Veuillez démarrer une nouvelle conversation.`);
        }
    }

    function autoResizeTextarea() {
        if (!messageInput) return;
        
        messageInput.style.height = 'auto';
        const newHeight = Math.min(messageInput.scrollHeight, 120);
        messageInput.style.height = newHeight + 'px';
        
        setTimeout(() => {
            scrollToBottom();
        }, 50);
    }

    function showModal(modalName) {
        const modal = document.getElementById(`${modalName}-modal`);
        if (modal) {
            modal.classList.add('active');
            isModalOpen = true;
            document.body.classList.add('no-scroll');
        }
    }
    
    function hideModal(modalName) {
        const modal = document.getElementById(`${modalName}-modal`);
        if (modal) {
            modal.classList.remove('active');
            isModalOpen = false;
            document.body.classList.remove('no-scroll');
        }
    }

    function setupModalCloseHandlers() {
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                const activeModal = document.querySelector('.modal-overlay.active');
                if (activeModal) {
                    activeModal.classList.remove('active');
                    isModalOpen = false;
                    document.body.classList.remove('no-scroll');
                }
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isModalOpen) {
                const activeModal = document.querySelector('.modal-overlay.active');
                if (activeModal) {
                    activeModal.classList.remove('active');
                    isModalOpen = false;
                    document.body.classList.remove('no-scroll');
                }
            }
        });
    }

    // ===== OPTIMISATIONS =====
    
    function setupPerformanceOptimizations() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, { threshold: 0.1 });
        
        if (conversationMessages) {
            const messages = conversationMessages.querySelectorAll('.message');
            messages.forEach(message => observer.observe(message));
        }
    }
    
    function cleanupOldConversations() {
        if (conversations.length > 20) {
            const unpinned = conversations.filter(c => !c.pinned);
            const toRemove = unpinned.slice(20);
            
            toRemove.forEach(conv => {
                const index = conversations.findIndex(c => c.id === conv.id);
                if (index !== -1) {
                    conversations.splice(index, 1);
                }
            });
            
            saveConversations();
            updateConversationList();
        }
    }

    // ===== DÉMARRAGE =====
    document.addEventListener('DOMContentLoaded', () => {
        try {
            loadTheme();
            loadLanguage();
            initApp();
            setupModalCloseHandlers();
            setupPerformanceOptimizations();
            cleanupOldConversations();
            
            console.log('Application CultureLink initialisée avec succès');
            console.log('APIs configurées - Texte:', TEXT_API_URL, 'Images:', IMAGE_API_URL);
            console.log('Langue actuelle:', currentLanguage);
            
        } catch (error) {
            console.error('Erreur lors de l\'initialisation:', error);
            alert(currentLanguage === 'en'
                ? "An error occurred while loading the application. Please refresh the page."
                : "Une erreur est survenue lors du chargement de l'application. Veuillez rafraîchir la page.");
        }
    });

    // ===== GESTION DES ERREURS GLOBALES =====
    window.addEventListener('error', function(event) {
        console.error('Erreur globale:', event.error);
    });
    
    window.addEventListener('unhandledrejection', function(event) {
        console.error('Promesse non gérée:', event.reason);
    });

    // Fonction pour supprimer un message (utilisée dans les boutons d'image)
    function deleteMessage(messageId) {
        if (!currentConversationId) return;
        
        const conversation = conversations.find(c => c.id === currentConversationId);
        if (!conversation) return;
        
        const messageIndex = conversation.messages.findIndex(m => m.id === messageId);
        if (messageIndex === -1) return;
        
        if (confirm(currentLanguage === 'en' ? 'Delete this image?' : 'Supprimer cette image ?')) {
            conversation.messages.splice(messageIndex, 1);
            conversation.updatedAt = new Date();
            
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                messageElement.remove();
            }
            
            saveConversations();
            updateConversationList();
        }
    }
</script>
</body>
</html>
